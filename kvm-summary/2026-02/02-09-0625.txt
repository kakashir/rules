From e7230a5ad to df8fd8c48
KVM mailing list update from e7230a5ad to df8fd8c48

Top 15 contributor Email domains (Based on Email Body)

      1 tu-dortmund.de
      1 suse.de

Top 15 contributors (Based on Email Body)

      1  =?UTF-8?q?Carlos=20L=C3=B3pez?= <clopez@suse.de>
      1  Simon Schippers <simon.schippers@tu-dortmund.de>

===== Patch list in this time period =====


===== Patch Commit Messages ====

New:  KVM: x86: synthesize TSA CPUID bits via SCATTERED_F()
[PATCH] KVM: x86: synthesize TSA CPUID bits via SCATTERED_F()
Author: Carlos López <clopez@suse.de>

KVM incorrectly synthesizes TSA_SQ_NO and TSA_L1_NO when running
on AMD Family 19h CPUs by using SYNTHESIZED_F(), which unconditionally
enables features for KVM-only CPUID leaves (as is the case with
CPUID_8000_0021_ECX), regardless of the kernel's synthesis logic in
tsa_init(). This is due to the following logic in kvm_cpu_cap_init():

    if (leaf < NCAPINTS)
        kvm_cpu_caps[leaf] &= kernel_cpu_caps[leaf];

This can cause an unexpected failure on Family 19h CPUs during SEV-SNP
guest setup, when userspace issues SNP_LAUNCH_UPDATE, as setting these
bits in the CPUID page on vulnerable CPUs is explicitly rejected by SNP
firmware.

Switch to SCATTERED_F(), so that the bits are only set if the features
have been force-set by the kernel in tsa_init(), or if they are reported
in the raw CPUID.

Fixes: 31272abd5974 ("KVM: SVM: Advertise TSA CPUID bits to guests")
Signed-off-by: Carlos López <clopez@suse.de>
---
 arch/x86/kvm/cpuid.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

----------------------------------------------------------------------

