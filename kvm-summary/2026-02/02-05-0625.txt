From b1e115a09 to 589d7a019
KVM mailing list update from b1e115a09 to 589d7a019

Top 15 contributor Email domains (Based on Email Body)

     30 linux.ibm.com
     13 amd.com
     11 redhat.com
     10 google.com
      4 linux.alibaba.com
      1 tu-dortmund.de
      1 nxp.com
      1 baidu.com
      1 aosc.io

Top 15 contributors (Based on Email Body)

     30  Claudio Imbrenda <imbrenda@linux.ibm.com>
     11  Marc-André Lureau <marcandre.lureau@redhat.com>
      9  Raghavendra Rao Ananta <rananta@google.com>
      8  Manali Shukla <manali.shukla@amd.com>
      4  Fangyu Yu <fangyu.yu@linux.alibaba.com>
      3  Kim Phillips <kim.phillips@amd.com>
      2  Santosh Shukla <santosh.shukla@amd.com>
      1  Zixing Liu <liushuyu@aosc.io>
      1  Simon Schippers <simon.schippers@tu-dortmund.de>
      1  Li RongQing <lirongqing@baidu.com>
      1  Ioana Ciornei <ioana.ciornei@nxp.com>
      1  Ackerley Tng <ackerleytng@google.com>

===== Patch list in this time period =====


===== Patch Commit Messages ====

New:  KVM: guest_memfd: Disable VMA merging with VM_DONTEXPAND
[PATCH] KVM: guest_memfd: Disable VMA merging with VM_DONTEXPAND
Author: Ackerley Tng <ackerleytng@google.com>

#syz test: git://git.kernel.org/pub/scm/virt/kvm/kvm.git next

guest_memfd VMAs don't need to be merged, especially now, since guest_memfd
only supports PAGE_SIZE folios.

Set VM_DONTEXPAND on guest_memfd VMAs.

In addition, this disables khugepaged from operating on guest_memfd folios,
which may result in unintended merging of guest_memfd folios.

Change-Id: I5867edcb66b075b54b25260afd22a198aee76df1
Signed-off-by: Ackerley Tng <ackerleytng@google.com>
---
 virt/kvm/guest_memfd.c | 6 ++++++
 1 file changed, 6 insertions(+)

----------------------------------------------------------------------

New:  KVM: s390: Refactor pgste lock and unlock functions
[PATCH v7 01/29] KVM: s390: Refactor pgste lock and unlock functions
Author: Claudio Imbrenda <imbrenda@linux.ibm.com>

Move the pgste lock and unlock functions back into mm/pgtable.c and
duplicate them in mm/gmap_helpers.c to avoid function name collisions
later on.

Signed-off-by: Claudio Imbrenda <imbrenda@linux.ibm.com>
---
 arch/s390/include/asm/pgtable.h | 22 ----------------------
 arch/s390/mm/gmap_helpers.c     | 23 ++++++++++++++++++++++-
 arch/s390/mm/pgtable.c          | 23 ++++++++++++++++++++++-
 3 files changed, 44 insertions(+), 24 deletions(-)

----------------------------------------------------------------------

New:  KVM: s390: gmap rewrite, the real deal
[PATCH v7 00/29] KVM: s390: gmap rewrite, the real deal
Author: Claudio Imbrenda <imbrenda@linux.ibm.com>

This series is the last big series of the gmap rewrite. It introduces
the new code and actually uses it. The old code is then removed.

KVM on s390 will now use the mmu_notifier, like most other
architectures. The gmap address space is now completely separate from
userspace; no level of the page tables is shared between guest mapping
and userspace.

One of the biggest advantages is that the page size of userspace is
completely independent of the page size used by the guest. Userspace
can mix normal pages, THPs, hugetlbfs, and more.

It's now possible to have nested guests and guests with huge pages
running on the same host. In fact, it's possible to have a nested
guest on a guest with huge pages. Transparent hugepages are also
possible.

Patches 1 to 11 are mostly preparations; introducing some new bits and
functions, and moving code around.

Patches 12 to 21 are the meat of the new gmap code; page table management
functions and gmap management. This is the code that will be used to
manage guest memory.

Patch 24 is unfortunately big; the existing code is converted to use
the new gmap and all references to the old gmap are removed. This needs
to be done all at once, unfortunately, hence the size of the patch.

Patch 25 and 26 remove all the now unused code.

Patch 27 and 28 allow for 1M pages to be used to back guests, and add
some more functions that are useful for testing.

Patch 29 contains selftests for the storage key interface introduced in
the patch 28

v6->v7:
* Added selftests for the newly introduced KEYOP ioctl
* Fix the bugs found by the newly introduced selftests
* Fix a bug in the memslot removal code
* Fix a few bugs in vSIE shadowing/deshawoding code
* Fix deadlock between shadowing code and normal fault handling
* Added proper locking for memslot manipulation operations
* Added capability for the KEYOP ioctl, and API documentation
* Minor documentation fixes
* Fixed many style issues in comments
* Fixed regression with ucontrol VMs

v5->v6:
* Added a mutex to avoid races during import-like operations in
  protected guests
* The functions uv_convert_from_secure_folio() and uv_destroy_folio()
  now work on the whole folio, and not just its first page
* Added warnings if uv_convert_from_secure_pte() fails in ptep_*()
* Changed the way shadow gmaps do reference counting
* Use a bitmap for gmap flags, instead of individual bool variables
* Rework the make_secure logic to work on gmap only, and not on
  userspace addresses
* Some refactorings
* Rebased onto 6.19-rc2
* Added more comments
* Minor style fixes

v4->v5:
* fix some locking issues
* fix comments and documentation

v3->v4:
* dat_link() can now return -ENOMEM when appropriate
* fixed a few vSIE races that led to use-after-free or deadlocks
* split part of the previous patch 23 and move it after patch 17, merge
  the rest of the patch into patch 19
* fix -ENOMEM handling in handle_pfmf() and handle_sske()

v2->v3:
* Add lots of small comments and cosmetic fixes
* Rename some functions to improve clarity
* Remove unused helper functions and macros
* Rename inline asm constraints labels to make them more understandable
* Refactor the code to pre-allocate the page tables (using custom
  caches) when sleeping is allowed, use the cached pages when holding
  spinlocks and handle gracefully allocation failures (i.e. retry
  instead of killing the guest)
* Refactor the code for fault handling; it's now in a separate file,
  and it takes a callback that can be optionally called when all the
  relevant locks are still held
* Use assembler mnemonics instead of manually specifying the opcode
  where appropriate
* Remove the LEVEL_* enum, and use TABLE_TYPE_* macros instead;
  introduce new TABLE_TYPE_PAGE_TABLE
* Remove usage of cpu_has_idte() since it is being removed from the
  kernel
* Improve storage key handling and PGSTE locking
* Introduce struct guest_fault to represent the state of a guest fault
  that is being resolved
* Minor CMMA fixes


Claudio Imbrenda (29):
  KVM: s390: Refactor pgste lock and unlock functions
  KVM: s390: Add P bit in table entry bitfields, move union vaddress
  s390: Make UV folio operations work on whole folio
  s390: Move sske_frame() to a header
  KVM: s390: Add gmap_helper_set_unused()
  KVM: s390: Introduce import_lock
  KVM: s390: Export two functions
  s390/mm: Warn if uv_convert_from_secure_pte() fails
  KVM: s390: vsie: Pass gmap explicitly as parameter
  KVM: s390: Enable KVM_GENERIC_MMU_NOTIFIER
  KVM: s390: Rename some functions in gaccess.c
  KVM: s390: KVM-specific bitfields and helper functions
  KVM: s390: KVM page table management functions: allocation
  KVM: s390: KVM page table management functions: clear and replace
  KVM: s390: KVM page table management functions: walks
  KVM: s390: KVM page table management functions: storage keys
  KVM: s390: KVM page table management functions: lifecycle management
  KVM: s390: KVM page table management functions: CMMA
  KVM: s390: New gmap code
  KVM: s390: Add helper functions for fault handling
  KVM: s390: Add some helper functions needed for vSIE
  KVM: s390: Stop using CONFIG_PGSTE
  KVM: s390: Storage key functions refactoring
  KVM: s390: Switch to new gmap
  KVM: s390: Remove gmap from s390/mm
  KVM: S390: Remove PGSTE code from linux/s390 mm
  KVM: s390: Enable 1M pages for gmap
  KVM: s390: Storage key manipulation IOCTL
  KVM: s390: selftests: Add selftest for the KVM_S390_KEYOP ioctl

 Documentation/virt/kvm/api.rst           |   42 +
 MAINTAINERS                              |    2 -
 arch/s390/Kconfig                        |    3 -
 arch/s390/include/asm/dat-bits.h         |   32 +-
 arch/s390/include/asm/gmap.h             |  174 --
 arch/s390/include/asm/gmap_helpers.h     |    1 +
 arch/s390/include/asm/hugetlb.h          |    6 -
 arch/s390/include/asm/kvm_host.h         |    7 +
 arch/s390/include/asm/mmu.h              |   13 -
 arch/s390/include/asm/mmu_context.h      |    6 +-
 arch/s390/include/asm/page.h             |    4 -
 arch/s390/include/asm/pgalloc.h          |    4 -
 arch/s390/include/asm/pgtable.h          |  171 +-
 arch/s390/include/asm/tlb.h              |    3 -
 arch/s390/include/asm/uaccess.h          |   70 +-
 arch/s390/include/asm/uv.h               |    3 +-
 arch/s390/kernel/uv.c                    |  142 +-
 arch/s390/kvm/Kconfig                    |    2 +
 arch/s390/kvm/Makefile                   |    3 +-
 arch/s390/kvm/dat.c                      | 1391 ++++++++++++
 arch/s390/kvm/dat.h                      |  970 +++++++++
 arch/s390/kvm/diag.c                     |    2 +-
 arch/s390/kvm/faultin.c                  |  148 ++
 arch/s390/kvm/faultin.h                  |   92 +
 arch/s390/kvm/gaccess.c                  |  958 +++++----
 arch/s390/kvm/gaccess.h                  |   20 +-
 arch/s390/kvm/gmap-vsie.c                |  141 --
 arch/s390/kvm/gmap.c                     | 1235 +++++++++++
 arch/s390/kvm/gmap.h                     |  244 +++
 arch/s390/kvm/intercept.c                |   15 +-
 arch/s390/kvm/interrupt.c                |    6 +-
 arch/s390/kvm/kvm-s390.c                 |  954 ++++-----
 arch/s390/kvm/kvm-s390.h                 |   27 +-
 arch/s390/kvm/priv.c                     |  213 +-
 arch/s390/kvm/pv.c                       |  177 +-
 arch/s390/kvm/vsie.c                     |  192 +-
 arch/s390/lib/uaccess.c                  |  184 +-
 arch/s390/mm/Makefile                    |    1 -
 arch/s390/mm/fault.c                     |    4 +-
 arch/s390/mm/gmap.c                      | 2436 ----------------------
 arch/s390/mm/gmap_helpers.c              |   96 +-
 arch/s390/mm/hugetlbpage.c               |   24 -
 arch/s390/mm/page-states.c               |    1 +
 arch/s390/mm/pageattr.c                  |    7 -
 arch/s390/mm/pgalloc.c                   |   24 -
 arch/s390/mm/pgtable.c                   |  814 +-------
 include/uapi/linux/kvm.h                 |   11 +
 mm/khugepaged.c                          |    9 -
 tools/testing/selftests/kvm/Makefile.kvm |    1 +
 tools/testing/selftests/kvm/s390/keyop.c |  299 +++
 50 files changed, 5889 insertions(+), 5495 deletions(-)

----------------------------------------------------------------------

New:  RISC-V: KVM: Support runtime configuration for per-VM's HGATP mode
[PATCH v5 1/3] RISC-V: KVM: Support runtime configuration for per-VM's HGATP mode
Author: fangyu.yu <fangyu.yu@linux.alibaba.com>


Introduces one per-VM architecture-specific fields to support runtime
configuration of the G-stage page table format:

- kvm->arch.kvm_riscv_gstage_pgd_levels: the corresponding number of page
  table levels for the selected mode.

These fields replace the previous global variables
kvm_riscv_gstage_mode and kvm_riscv_gstage_pgd_levels, enabling different
virtual machines to independently select their G-stage page table format
instead of being forced to share the maximum mode detected by the kernel
at boot time.

Signed-off-by: Fangyu Yu <fangyu.yu@linux.alibaba.com>
---
 arch/riscv/include/asm/kvm_gstage.h | 20 +++++----
 arch/riscv/include/asm/kvm_host.h   | 19 +++++++++
 arch/riscv/kvm/gstage.c             | 65 ++++++++++++++---------------
 arch/riscv/kvm/main.c               | 12 +++---
 arch/riscv/kvm/mmu.c                | 20 +++++----
 arch/riscv/kvm/vm.c                 |  2 +-
 arch/riscv/kvm/vmid.c               |  3 +-
 7 files changed, 84 insertions(+), 57 deletions(-)

----------------------------------------------------------------------

Exist: [PATCH v5 1/3] RISC-V: KVM: Support runtime configuration for per-VM's HGATP mode
 Skip: [PATCH v5 0/3] Support runtime configuration for per-VM's HGATP mode
New:  vfio/fsl-mc: add myself as maintainer
[PATCH] vfio/fsl-mc: add myself as maintainer
Author: Ioana Ciornei <ioana.ciornei@nxp.com>

Add myself as maintainer of the vfio/fsl-mc driver. The driver is still
highly in use on Layerscape DPAA2 SoCs.

Signed-off-by: Ioana Ciornei <ioana.ciornei@nxp.com>
---
 MAINTAINERS                       | 3 ++-
 drivers/vfio/fsl-mc/Kconfig       | 5 +----
 drivers/vfio/fsl-mc/vfio_fsl_mc.c | 2 --
 3 files changed, 3 insertions(+), 7 deletions(-)

----------------------------------------------------------------------

New:  system/rba: use DIV_ROUND_UP
[PATCH 01/10] system/rba: use DIV_ROUND_UP
Author: marcandre.lureau <marcandre.lureau@redhat.com>


Mostly for readability.

Signed-off-by: Marc-André Lureau <marcandre.lureau@redhat.com>
---
 system/ram-block-attributes.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

----------------------------------------------------------------------

New:  RFC: make RamDiscardManager work with multiple sources
[PATCH 00/10] RFC: make RamDiscardManager work with multiple sources
Author: marcandre.lureau <marcandre.lureau@redhat.com>


Hi,

This is an attempt to fix the incompatibility of virtio-mem with confidential
VMs. The solution implements what was discussed earlier with D. Hildenbrand:
https://patchwork.ozlabs.org/project/qemu-devel/patch/20250407074939.18657-5-chenyi.qiang@intel.com/#3502238

The first patches are misc cleanups. Then some code refactoring to have split a
manager/source. And finally, the manager learns to deal with multiple sources.

I haven't done thorough testing. I only launched a SEV guest with a virtio-mem
device. It would be nice to have more tests for those scenarios with
VFIO/virtio-mem/confvm.. In any case, review & testing needed!

(should fix https://issues.redhat.com/browse/RHEL-131968)

thanks

Marc-André Lureau (10):
  system/rba: use DIV_ROUND_UP
  memory: drop RamDiscardListener::double_discard_supported
  virtio-mem: use warn_report_err_once()
  system/memory: minor doc fix
  kvm: replace RamDicardManager by the RamBlockAttribute
  system/memory: split RamDiscardManager into source and manager
  system/memory: move RamDiscardManager to separate compilation unit
  system/memory: constify section arguments
  memory: implement RamDiscardManager multi-source aggregation
  tests: add unit tests for RamDiscardManager multi-source aggregation

 include/hw/vfio/vfio-container.h            |    2 +-
 include/hw/vfio/vfio-cpr.h                  |    2 +-
 include/hw/virtio/virtio-mem.h              |    3 -
 include/system/memory.h                     |  285 +---
 include/system/ram-discard-manager.h        |  394 ++++++
 include/system/ramblock.h                   |    3 +-
 accel/kvm/kvm-all.c                         |    2 +-
 hw/vfio/cpr-legacy.c                        |    4 +-
 hw/vfio/listener.c                          |   12 +-
 hw/virtio/virtio-mem.c                      |  204 +--
 migration/ram.c                             |    6 +-
 system/memory.c                             |   78 +-
 system/memory_mapping.c                     |    4 +-
 system/ram-block-attributes.c               |  205 +--
 system/ram-discard-manager.c                |  590 +++++++++
 tests/unit/test-ram-discard-manager-stubs.c |   48 +
 tests/unit/test-ram-discard-manager.c       | 1313 +++++++++++++++++++
 system/meson.build                          |    1 +
 tests/unit/meson.build                      |    8 +-
 19 files changed, 2489 insertions(+), 675 deletions(-)

----------------------------------------------------------------------

New:  KVM: x86: Fix SRCU list traversal in kvm_fire_mask_notifiers()
[PATCH] KVM: x86: Fix SRCU list traversal in kvm_fire_mask_notifiers()
Author: lirongqing <lirongqing@baidu.com>


The mask_notifier_list is protected by kvm->irq_srcu, but the traversal
in kvm_fire_mask_notifiers() incorrectly uses hlist_for_each_entry_rcu().
This leads to lockdep warnings because the standard RCU iterator expects
to be under rcu_read_lock(), not SRCU.

Replace the RCU variant with hlist_for_each_entry_srcu() and provide
the proper srcu_read_lock_held() annotation to ensure correct
synchronization and silence lockdep.

Signed-off-by: Li RongQing <lirongqing@baidu.com>
---
 arch/x86/kvm/ioapic.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

----------------------------------------------------------------------

New:  KVM: x86: Refactor APIC register mask handling to support extended APIC registers
[PATCH v1 1/9] KVM: x86: Refactor APIC register mask handling to support extended APIC registers
Author: Manali Shukla <manali.shukla@amd.com>

Expand the APIC register mask infrastructure from a single u64 to
a u64[2] array to accommodate both standard APIC registers (0x0-0x3f0)
and extended APIC registers (0x400-0x530).  Current AMD processors
support four extended LVT registers; future processors may support up to
255.

The existing single 64-bit mask can track at most 64 registers (with 16-
byte granularity), which is insufficient for the extended APIC register
space.  A 128-bit mask (u64[2]) provides coverage for both standard and
extended register ranges.

Convert the bitmask infrastructure to use kernel bitmap APIs.
APIC_REG_MASK now sets bits in the u64[2] array via bitmap_set(),
APIC_REG_TEST checks register validity via test_bit(), and
kvm_lapic_readable_reg_mask() populates the expanded mask as an output
parameter instead of a return value.

Update all callers, including vmx_update_msr_bitmap_x2apic() in VMX, to
pass and utilize the new two-element mask array. Currently, extended
APIC registers are only supported for AMD processors.

No functional change intended; extended APIC register emulation will be
added in a subsequent patch.

Suggested-by: Naveen N Rao (AMD) <naveen@kernel.org>
Suggested-by: Dapeng Mi <dapeng1.mi@linux.intel.com>
Signed-off-by: Manali Shukla <manali.shukla@amd.com>
---
 arch/x86/kvm/lapic.c   | 96 ++++++++++++++++++++++++++----------------
 arch/x86/kvm/lapic.h   |  2 +-
 arch/x86/kvm/vmx/vmx.c | 10 +++--
 3 files changed, 67 insertions(+), 41 deletions(-)

----------------------------------------------------------------------

New:  KVM: x86: Add support for AMD Extended APIC registers
[PATCH v1 0/9] KVM: x86: Add support for AMD Extended APIC registers
Author: Manali Shukla <manali.shukla@amd.com>

Add support for AMD's Extended APIC registers, which reside in a 4KB
APIC page instead of the legacy 1KB APIC register space.  Extended LVT
registers (offsets 0x500-0x530) provide additional interrupt vectors
for features like Instruction Based Sampling (IBS).

Introduce KVM_CAP_LAPIC2 to allow userspace to opt into the full 4KB
APIC register space. The capability uses a bitmask to support different
APIC extensions:

  KVM_LAPIC2_DEFAULT: 4KB APIC register space (common foundation)
  KVM_LAPIC2_AMD_DEFAULT: Extended LVT registers (AMD-specific)

Add KVM_GET/SET_LAPIC2 ioctls that operate on a 4KB APIC register space
accommodate extended registers.  Legacy KVM_GET/SET_LAPIC continue to
work for backward compatibility.

Emulate extended APIC registers (APIC_EFEAT, APIC_ECTRL, APIC_EILVTn)
when the guest has X86_FEATURE_EXTAPIC and userspace enables
KVM_CAP_LAPIC2.  Current AMD processors support four extended LVT
entries, future processors may support up to 255.

Integrate with AVIC to accelerate extended LVT MSR access when
AVIC_EXTLVT is supported.  Reads are accelerated without VM-exits;
writes trigger trap-style VM-exits.

Tested on AMD hardware with Extapic support:
- Extended APIC register read/write emulation and AVIC acceleration
  with IBS driver running on the guest
- VM migration with extended APIC state and without extended APIC state
- Backward compatibility check:
  Fallback to legacy IOCTLs when KVM_CAP_LAPIC2 capability is not enabled

Equivalent Qemu changes can be found at:
https://github.com/AMDESE/qemu/tree/extlvt_v1

Patches are prepared on kvm-x86/next (003f68c79227).

Manali Shukla (7):
  KVM: x86: Refactor APIC register mask handling to support extended
    APIC registers
  x86/apic: Add helper to get maximum number of Extended LVT registers
  KVM: SVM: Set kvm_caps.has_extapic when CPU supports Extended APIC
  KVM: x86: Introduce KVM_CAP_LAPIC2 for 4KB APIC register space support
  KVM: x86: Refactor APIC state get/set to accept variable-sized buffers
  KVM: Add KVM_GET_LAPIC2 and KVM_SET_LAPIC2 for extended APIC
  KVM: SVM: Add AVIC support for extended LVT MSRs

Santosh Shukla (2):
  KVM: x86: Emulate Extended LVT registers for AMD guests
  x86/cpufeatures: Add CPUID feature bit for Extended LVT AVIC
    acceleration

 Documentation/virt/kvm/api.rst     |  75 +++++++++++++
 arch/x86/include/asm/apic.h        |   1 +
 arch/x86/include/asm/apicdef.h     |  18 +++
 arch/x86/include/asm/cpufeatures.h |   1 +
 arch/x86/include/asm/kvm_host.h    |  12 ++
 arch/x86/include/uapi/asm/kvm.h    |   5 +
 arch/x86/kernel/apic/apic.c        |  17 +++
 arch/x86/kvm/cpuid.c               |  10 +-
 arch/x86/kvm/lapic.c               | 169 ++++++++++++++++++++---------
 arch/x86/kvm/lapic.h               |  14 ++-
 arch/x86/kvm/svm/avic.c            |  14 +++
 arch/x86/kvm/svm/svm.c             |   3 +
 arch/x86/kvm/vmx/vmx.c             |  10 +-
 arch/x86/kvm/x86.c                 |  93 +++++++++++++++-
 arch/x86/kvm/x86.h                 |   2 +
 include/uapi/linux/kvm.h           |   7 ++
 16 files changed, 390 insertions(+), 61 deletions(-)

----------------------------------------------------------------------

New:  vfio: selftests: Add -Wall and -Werror to the Makefile
[PATCH v3 1/8] vfio: selftests: Add -Wall and -Werror to the Makefile
Author: Raghavendra Rao Ananta <rananta@google.com>

Add the compiler flags, -Wall and -Werror, to catch all the build
warnings and flag them as a build error, respectively. This is to
ensure that no obvious programmer errors are introduced. We can
add -Wno-* flags in the future to ignore specific warnings as necesasry.

Signed-off-by: Raghavendra Rao Ananta <rananta@google.com>
---
 tools/testing/selftests/vfio/Makefile | 1 +
 1 file changed, 1 insertion(+)

----------------------------------------------------------------------

New:  vfio: selftest: Add SR-IOV UAPI test
[PATCH v3 0/8] vfio: selftest: Add SR-IOV UAPI test
Author: Raghavendra Rao Ananta <rananta@google.com>

Hello,

This series adds a vfio selftest, vfio_pci_sriov_uapi_test.c, to get some
coverage on SR-IOV UAPI handling. Specifically, it includes the
following cases that iterates over all the iommu modes:
 - Setting correct/incorrect/NULL tokens during device init.
 - Close the PF device immediately after setting the token.
 - Change/override the PF's token after device init.

The test takes care of creating/setting up the VF device, and hence, it
can be executed like any other test, simply by passing the PF's BDF to
run.sh. For example,

$ ./scripts/setup.sh 0000:16:00.1
$ ./scripts/run.sh ./vfio_pci_sriov_uapi_test

TAP version 13
1..45
# Starting 45 tests from 15 test cases.
#  RUN           vfio_pci_sriov_uapi_test.vfio_type1_iommu_same_uuid.init_token_match ...
Created 1 VF (0000:1a:00.0) under the PF: 0000:16:00.1
#            OK  vfio_pci_sriov_uapi_test.vfio_type1_iommu_same_uuid.init_token_match
ok 1 vfio_pci_sriov_uapi_test.vfio_type1_iommu_same_uuid.init_token_match
#  RUN           vfio_pci_sriov_uapi_test.vfio_type1_iommu_same_uuid.pf_early_close ...
Created 1 VF (0000:1a:00.0) under the PF: 0000:16:00.1
#            OK  vfio_pci_sriov_uapi_test.vfio_type1_iommu_same_uuid.pf_early_close
ok 2 vfio_pci_sriov_uapi_test.vfio_type1_iommu_same_uuid.pf_early_close
[...]
#  RUN           vfio_pci_sriov_uapi_test.iommufd_null_uuid.override_token ...
Created 1 VF (0000:1a:00.0) under the PF: 0000:16:00.1
#            OK  vfio_pci_sriov_uapi_test.iommufd_null_uuid.override_token
ok 45 vfio_pci_sriov_uapi_test.iommufd_null_uuid.override_token
# PASSED: 45 / 45 tests passed.
# Totals: pass:45 fail:0 xfail:0 xpass:0 skip:0 error:0

Thank you.
Raghavendra

v3: Suggestions by David Matlack (thanks!)
- Introduce a patch to add -Wall and -Werror to the vfio Makefile.
- Use snprintf_assert() where they were missed.
- Rename the functions as suggested in the sysfs lib and the test file.
- Alloc the output char * buffer in the functions sysfs_driver_get() and
  sysfs_sriov_vf_bdf_get() instead of relying on the caller to pass one.
  The caller is now responsible for freeing these buffers.
- Remove unnecessary initializations of local variables in sysfs and the
  vfio_pci_device libraries.
- Move the inclusion of -luuid to the top level Makefile.
- Introduce vfio_pci_device_{alloc|free}() and let the test and the functions in
  vfio_pci_device.c use this.
- Return -errno for the ioctl failure in __vfio_device_bind_iommufd() instead of
  directly calling ioctl_assert().
- Since the vfio-pci driver sets the 'driver_override' to the driver of PF,
  instead of clearing sriov_drivers_autoprobe and binding the VF explicitly to
  the 'vfio-pci' driver, only assert that it's already bound.
- By extension to the above point, remove the unnecessary functions from the sysfs
  lib.

v2: Suggestions by David Matlack (thank you)
 - Introduce snprintf_assert() to check against content trucation.
 - Introduce a new sysfs library to handle all the common vfio/pci sysfs
   operations.
 - Rename vfio_pci_container_get_device_fd() to
   vfio_pci_group_get_device_fd().
 - Use a fixed size 'arg' array instead of dynamic allocation in
   __vfio_pci_group_get_device_fd().
 - Exclude vfio_pci_device_init() to accept the 'vf_token' arg.
 - Move the vfio_pci_sriov_uapi_test.c global variable to the FIXTURE()
   struct or as TEST_F() local variables.
 - test_vfio_pci_container_setup() returns 'int' to indicate status.
 - Skip the test if nr_vfs != 0.
 - Explicitly set "sriov_drivers_autoprobe" for the PF.
 - Make sure to bind the VF device to the "vfio-pci" driver.
 - Cleanup the things done by FIXTURE_SETUP() in FIXTURE_TEARDOWN().

v2: https://lore.kernel.org/all/20251210181417.3677674-1-rananta@google.com/
v1: https://lore.kernel.org/all/20251104003536.3601931-1-rananta@google.com/

Raghavendra Rao Ananta (8):
  vfio: selftests: Add -Wall and -Werror to the Makefile
  vfio: selftests: Introduce snprintf_assert()
  vfio: selftests: Introduce a sysfs lib
  vfio: selftests: Extend container/iommufd setup for passing vf_token
  vfio: selftests: Expose more vfio_pci_device functions
  vfio: selftests: Add helper to set/override a vf_token
  vfio: selftests: Add helpers to alloc/free vfio_pci_device
  vfio: selftests: Add tests to validate SR-IOV UAPI

 tools/testing/selftests/vfio/Makefile         |   4 +
 .../selftests/vfio/lib/include/libvfio.h      |   1 +
 .../vfio/lib/include/libvfio/assert.h         |   5 +
 .../vfio/lib/include/libvfio/sysfs.h          |  12 ++
 .../lib/include/libvfio/vfio_pci_device.h     |  11 +
 tools/testing/selftests/vfio/lib/libvfio.mk   |   1 +
 tools/testing/selftests/vfio/lib/sysfs.c      | 136 ++++++++++++
 .../selftests/vfio/lib/vfio_pci_device.c      | 156 ++++++++++----
 .../selftests/vfio/vfio_dma_mapping_test.c    |   6 +-
 .../selftests/vfio/vfio_pci_device_test.c     |  21 +-
 .../selftests/vfio/vfio_pci_sriov_uapi_test.c | 200 ++++++++++++++++++
 11 files changed, 502 insertions(+), 51 deletions(-)

----------------------------------------------------------------------

New:  x86/sev: Allow IBPB-on-Entry feature for SNP guests
[PATCH v2 1/3] x86/sev: Allow IBPB-on-Entry feature for SNP guests
Author: Kim Phillips <kim.phillips@amd.com>

The SEV-SNP IBPB-on-Entry feature does not require a guest-side
implementation. The feature was added in Zen5 h/w, after the first
SNP Zen implementation, and thus was not accounted for when the
initial set of SNP features were added to the kernel.

In its abundant precaution, commit 8c29f0165405 ("x86/sev: Add SEV-SNP
guest feature negotiation support") included SEV_STATUS' IBPB-on-Entry
bit as a reserved bit, thereby masking guests from using the feature.

Allow guests to make use of IBPB-on-Entry when supported by the
hypervisor, as the bit is now architecturally defined and safe to
expose.

Fixes: 8c29f0165405 ("x86/sev: Add SEV-SNP guest feature negotiation support")
Reviewed-by: Nikunj A Dadhania <nikunj@amd.com>
Reviewed-by: Tom Lendacky <thomas.lendacky@amd.com>
Cc: Borislav Petkov (AMD) <bp@alien8.de>
Cc: Michael Roth <michael.roth@amd.com>
Cc: stable@kernel.org
Signed-off-by: Kim Phillips <kim.phillips@amd.com>
---
v2:
 - Change title (Nikunj)
 - Add reviews-by (Nikunj, Tom)
 - Change the description to more generally explain what the patch does (Boris)
v1: https://lore.kernel.org/kvm/20260126224205.1442196-2-kim.phillips@amd.com/

 arch/x86/boot/compressed/sev.c   | 1 +
 arch/x86/coco/sev/core.c         | 1 +
 arch/x86/include/asm/msr-index.h | 5 ++++-
 3 files changed, 6 insertions(+), 1 deletion(-)

----------------------------------------------------------------------

