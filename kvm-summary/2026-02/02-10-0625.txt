From df8fd8c48 to bef2e5d28
KVM mailing list update from df8fd8c48 to bef2e5d28

Top 15 contributor Email domains (Based on Email Body)

      6 163.com
      3 linux.dev
      1 suse.de
      1 linux.ibm.com
      1 google.com
      1 gmail.com

Top 15 contributors (Based on Email Body)

      6  Zhiquan Li <zhiquan_li@163.com>
      3  Yosry Ahmed <yosry.ahmed@linux.dev>
      1  =?UTF-8?q?Carlos=20L=C3=B3pez?= <clopez@suse.de>
      1  Suren Baghdasaryan <surenb@google.com>
      1  Steffen Eiden <seiden@linux.ibm.com>
      1  "shaikh.kamal" <shaikhkamal2012@gmail.com>

===== Patch list in this time period =====


===== Patch Commit Messages ====

New:  mm: replace vma_start_write() with vma_start_write_killable()
[PATCH 1/1] mm: replace vma_start_write() with vma_start_write_killable()
Author: Suren Baghdasaryan <surenb@google.com>

Now that we have vma_start_write_killable() we can replace most of the
vma_start_write() calls with it, improving reaction time to the kill
signal.

There are several places which are left untouched by this patch:

1. free_pgtables() because function should free page tables even if a
fatal signal is pending.

2. userfaultd code, where some paths calling vma_start_write() can
handle EINTR and some can't without a deeper code refactoring.

3. vm_flags_{set|mod|clear} require refactoring that involves moving
vma_start_write() out of these functions and replacing it with
vma_assert_write_locked(), then callers of these functions should
lock the vma themselves using vma_start_write_killable() whenever
possible.

Suggested-by: Matthew Wilcox <willy@infradead.org>
Signed-off-by: Suren Baghdasaryan <surenb@google.com>
---
 arch/powerpc/kvm/book3s_hv_uvmem.c |  5 +-
 include/linux/mempolicy.h          |  5 +-
 mm/khugepaged.c                    |  5 +-
 mm/madvise.c                       |  4 +-
 mm/memory.c                        |  2 +
 mm/mempolicy.c                     | 23 ++++++--
 mm/mlock.c                         | 20 +++++--
 mm/mprotect.c                      |  4 +-
 mm/mremap.c                        |  4 +-
 mm/pagewalk.c                      | 20 +++++--
 mm/vma.c                           | 94 +++++++++++++++++++++---------
 mm/vma_exec.c                      |  6 +-
 12 files changed, 139 insertions(+), 53 deletions(-)

----------------------------------------------------------------------

New:  KVM: SVM: Triple fault L1 on unintercepted EFER.SVME clear by L2
[PATCH v2 1/2] KVM: SVM: Triple fault L1 on unintercepted EFER.SVME clear by L2
Author: Yosry Ahmed <yosry.ahmed@linux.dev>

KVM tracks when EFER.SVME is set and cleared to initialize and tear down
nested state. However, it doesn't differentiate if EFER.SVME is getting
toggled in L1 or L2+. If L2 clears EFER.SVME, and L1 does not intercept
the EFER write, KVM exits guest mode and tears down nested state while
L2 is running, executing L1 without injecting a proper #VMEXIT.

According to the APM:

    The effect of turning off EFER.SVME while a guest is running is
    undefined; therefore, the VMM should always prevent guests from
    writing EFER.

Since the behavior is architecturally undefined, KVM gets to choose what
to do. Inject a triple fault into L1 as a more graceful option that
running L1 with corrupted state.

Co-developed-by: Sean Christopherson <seanjc@google.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Signed-off-by: Yosry Ahmed <yosry.ahmed@linux.dev>
---
 arch/x86/kvm/svm/svm.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

----------------------------------------------------------------------

New:  KVM: nSVM: Handle L2 clearing EFER.SVME properly
[PATCH v2 0/2] KVM: nSVM: Handle L2 clearing EFER.SVME properly
Author: Yosry Ahmed <yosry.ahmed@linux.dev>

Add more graceful handling of L2 clearing EFER.SVME without L1
interception, which is architecturally undefined. Shutdown L1 instead of
running it with corrupted L2 state, and add a test to verify the new
behavior.

I did not CC stable on patch 1 because it's not technically a KVM bug,
but it would be nice to have it backported. Leaving the decision to
Sean.

Yosry Ahmed (2):
  KVM: SVM: Triple fault L1 on unintercepted EFER.SVME clear by L2
  KVM: selftests: Add a test for L2 clearing EFER.SVME without intercept

 arch/x86/kvm/svm/svm.c                        | 11 ++++
 tools/testing/selftests/kvm/Makefile.kvm      |  1 +
 .../kvm/x86/svm_nested_clear_efer_svme.c      | 55 +++++++++++++++++++
 3 files changed, 67 insertions(+)

----------------------------------------------------------------------

New:  KVM: mmu_notifier: make mn_invalidate_lock non-sleeping for non-blocking invalidations
[PATCH] KVM: mmu_notifier: make mn_invalidate_lock non-sleeping for non-blocking invalidations
Author: shaikh.kamal <shaikhkamal2012@gmail.com>

mmu_notifier_invalidate_range_start() may be invoked via
mmu_notifier_invalidate_range_start_nonblock(), e.g. from oom_reaper(),
where sleeping is explicitly forbidden.

KVM's mmu_notifier invalidate_range_start currently takes
mn_invalidate_lock using spin_lock(). On PREEMPT_RT, spin_lock() maps
to rt_mutex and may sleep, triggering:

  BUG: sleeping function called from invalid context

This violates the MMU notifier contract regardless of PREEMPT_RT; RT
kernels merely make the issue deterministic.

Fix by converting mn_invalidate_lock to a raw spinlock so that
invalidate_range_start() remains non-sleeping while preserving the
existing serialization between invalidate_range_start() and
invalidate_range_end().

Signed-off-by: shaikh.kamal <shaikhkamal2012@gmail.com>
---
 include/linux/kvm_host.h |  2 +-
 virt/kvm/kvm_main.c      | 18 +++++++++---------
 2 files changed, 10 insertions(+), 10 deletions(-)

----------------------------------------------------------------------

New:  KVM: s390: Increase permitted SE header size to 1 MiB
[PATCH v1 1/1] KVM: s390: Increase permitted SE header size to 1 MiB
Author: Steffen Eiden <seiden@linux.ibm.com>

Relax the maximum allowed Secure Execution (SE) header size from
8 KiB to 1 MiB. This allows individual secure guest images to run on a
wider range of physical machines.

Signed-off-by: Steffen Eiden <seiden@linux.ibm.com>
---
 arch/s390/kvm/kvm-s390.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

----------------------------------------------------------------------

New:  KVM: x86: selftests: Add CPU vendor detection for Hygon
[PATCH RESEND 1/5] KVM: x86: selftests: Add CPU vendor detection for Hygon
Author: Zhiquan Li <zhiquan_li@163.com>

Currently some KVM selftests are failed on Hygon CPUs due to missing
vendor detection and edge-case handling specific to Hygon's
architecture.

Add CPU vendor detection for Hygon and add a global variable
"host_cpu_is_hygon" as the basic facility for the following fixes.

Signed-off-by: Zhiquan Li <zhiquan_li@163.com>
---
 tools/testing/selftests/kvm/include/x86/processor.h | 6 ++++++
 tools/testing/selftests/kvm/lib/x86/processor.c     | 3 +++
 2 files changed, 9 insertions(+)

----------------------------------------------------------------------

New:  KVM: x86: selftests: Add Hygon CPUs support and fix failures
[PATCH RESEND 0/5] KVM: x86: selftests: Add Hygon CPUs support and fix failures
Author: Zhiquan Li <zhiquan_li@163.com>

This series to add support for Hygon CPUs and fix 11 KVM selftest failures
on Hygon architecture.

Patch 1 add CPU vendor detection for Hygon and add a global variable
"host_cpu_is_hygon" to identify if the test is running on a Hygon CPU.
It is the prerequisite for the following fixes.

Patch 2 fix x86/fix_hypercall_test test failure by altering the hypercall
instruction on Hygon CPUs.

Patch 3 fix following test failures by avoiding using the reserved
memory regions on Hygon CPUs.
- access_tracking_perf_test
- demand_paging_test
- dirty_log_perf_test
- dirty_log_test
- kvm_page_table_test
- memslot_modification_stress_test
- pre_fault_memory_test
- x86/dirty_log_page_splitting_test

Patch 4 fix x86/pmu_event_filter_test test failure by allowing the tests
for Hygon CPUs.

Patch 5 fix x86/msrs_test test failure by fixing the expectation while
writing the MSR_TSC_AUX reserved bits without RDPID support.

Zhiquan Li (5):
  KVM: x86: selftests: Add CPU vendor detection for Hygon
  KVM: x86: selftests: Alter the instruction of hypercall on Hygon
  KVM: x86: selftests: Avoid failures due to reserved memory address
    regions on Hygon
  KVM: x86: selftests: Allow the PMU event filter test for Hygon
  KVM: x86: selftests: Fix write MSR_TSC_AUX reserved bits test failure
    on Hygon

 .../selftests/kvm/include/x86/processor.h     |  6 +++++
 .../testing/selftests/kvm/lib/x86/processor.c | 12 ++++++---
 .../selftests/kvm/x86/fix_hypercall_test.c    |  2 +-
 tools/testing/selftests/kvm/x86/msrs_test.c   | 26 +++++++++++++++----
 .../selftests/kvm/x86/pmu_event_filter_test.c |  6 ++---
 5 files changed, 39 insertions(+), 13 deletions(-)

----------------------------------------------------------------------

