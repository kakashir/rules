From e3d211428 to d743ff4d7
KVM mailing list update from e3d211428 to d743ff4d7

Top 15 contributor Email domains (Based on Email Body)

     15 linaro.org
      9 amd.com
      8 google.com
      2 linux.dev
      1 tum.de

Top 15 contributors (Based on Email Body)

     13  Pierrick Bouvier <pierrick.bouvier@linaro.org>
      9  Manali Shukla <manali.shukla@amd.com>
      8  Sean Christopherson <seanjc@google.com>
      2  Yosry Ahmed <yosry.ahmed@linux.dev>
      2  Peter Maydell <peter.maydell@linaro.org>
      1  Manuel Andreas <manuel.andreas@tum.de>

===== Patch list in this time period =====


===== Patch Commit Messages ====

New:  x86/hyper-v: Validate entire GVA range for non-canonical
[PATCH] x86/hyper-v: Validate entire GVA range for non-canonical
Author: Manuel Andreas <manuel.andreas@tum.de>

In KVM guests with Hyper-V hypercalls enabled, the hypercalls
HVCALL_FLUSH_VIRTUAL_ADDRESS_LIST and HVCALL_FLUSH_VIRTUAL_ADDRESS_LIST_EX
allow a guest to request invalidation of portions of a virtual TLB.
For this, the hypercall parameter includes a list of GVAs that are supposed
to be invalidated.

Currently, only the base GVA is checked to be canonical. In reality,
this check needs to be performed for the entire range of GVAs.
This still enables guests running on Intel hardware to trigger a
WARN_ONCE in the host (see prior commit below).

This patch simply moves the check for non-canonical addresses to be
performed for every single GVA of the supplied range. This should also
be more in line with the Hyper-V specification, since, although
unlikely, a range starting with an invalid GVA may still contain
GVAs that are valid.

Fixes: fa787ac07b3c ("KVM: x86/hyper-v: Skip non-canonical addresses during PV TLB flush")
Signed-off-by: Manuel Andreas <manuel.andreas@tum.de>
---
 arch/x86/kvm/hyperv.c | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

----------------------------------------------------------------------

New:  i386/kvm: Refactor APIC state functions to use generic register pointer
[PATCH v1 1/8] i386/kvm: Refactor APIC state functions to use generic register pointer
Author: Manali Shukla <manali.shukla@amd.com>

Change kvm_put_apic_state() and kvm_get_apic_state() to accept a void *
instead of struct kvm_lapic_state *, so they can work with both the
legacy 1KB and the 4KB LAPIC2 register layout in later patches.

Update kvm_apic_set_reg() and kvm_apic_get_reg() to take void * with
explicit char * casts for correct pointer arithmetic.

This is a preparation for LAPIC2 ioctl space and extended LVT for AMD
changes.

No functional change intended.

Signed-off-by: Manali Shukla <manali.shukla@amd.com>
---
 hw/i386/kvm/apic.c         | 48 +++++++++++++++++++-------------------
 target/i386/kvm/kvm_i386.h |  2 +-
 2 files changed, 25 insertions(+), 25 deletions(-)

----------------------------------------------------------------------

New:  i386/kvm: Add support for extended APIC register space
[PATCH v1 0/8] i386/kvm: Add support for extended APIC register space
Author: Manali Shukla <manali.shukla@amd.com>

Add support for KVM_CAP_LAPIC2, which enables the full 4KB APIC register
page instead of the legacy 1KB register space. The capability uses a bitmask
design to support different APIC extensions:

  - KVM_LAPIC2_DEFAULT: Basic 4KB APIC page support
  - KVM_LAPIC2_AMD_DEFAULT: AMD extended LVT registers within the 4KB page

The base capability (KVM_LAPIC2_DEFAULT) provides the foundation for
exposing the full APIC register space.

AMD processors with the ExtApicSpace feature (CPUID 8000_0001h.ECX[3])
further extend LAPIC space with additional LVT registers starting at offset
0x400. These extended LVT registers provide additional interrupt vectors
for AMD-specific features like Instruction Based Sampling (IBS).

This series implements:

1. Refactoring of existing APIC state functions to use generic pointers,
   allowing them to work with both 1KB and 4KB APIC register spaces.

2. Infrastructure to detect extended APIC support via arch_has_extapic()
   and track negotiated capabilities.

3. Extension of APICCommonState to store AMD extended APIC register state
   (efeat, ectrl, extlvt array) with dynamic allocation based on the
   number of extended LVT entries.

4. Capability negotiation during vCPU pre-creation:
   - Always request KVM_LAPIC2_DEFAULT for 4KB APIC page
   - Additionally request KVM_LAPIC2_AMD_DEFAULT if CPU has ExtApicSpace
   - Enable the intersection of KVM and QEMU capabilities

5. New KVM_GET/SET_LAPIC2 ioctls operating on struct kvm_lapic_state2
   (4KB) instead of struct kvm_lapic_state (1KB), with automatic
   fallback to legacy ioctls for compatibility.

6. New subsection of the vmstate (vmstate_apic_extended) of apic_common
   module is added to make migration of extended APIC registers deterministic.

This series depends on the corresponding KVM patches:
  https://lore.kernel.org/kvm/20260204074452.55453-1-manali.shukla@amd.com/

Patch 8 contains temporary UAPI definitions for testing and should NOT
be merged. These definitions will be imported via update-linux-headers.sh
once the kernel patches are merged.

Testing:
  - Verified extended APIC state synchronization on AMD hardware with
    ExtApicSpace support
  - Confirmed fallback to legacy APIC ioctls on older KVM versions
  - Validated VM migration compatibility
  - Ran migration tests from Qemu to make sure there are no regressions due to
    the changes done.

Repo : https://github.com/qemu/qemu.git
branch : v10.1.0
base commit : f8b2f64e23

Manali Shukla (8):
  i386/kvm: Refactor APIC state functions to use generic register
    pointer
  i386/kvm: Pass APICCommonState directly to kvm_get_apic_state()
  i386/apic: Add extended APIC helper functions
  i386/kvm: Add extended APIC state to APICCommonState
  i386/kvm: Add extended LAPIC capability negotiation
  i386/kvm: Add KVM_GET/SET_LAPIC2 support for extended APIC state
  apic_common: migrate extended APIC fields
  DO NOT MERGE: Temporary EXTAPIC UAPI definitions

 hw/i386/kvm/apic.c              | 123 +++++++++++++++++++++++++-------
 hw/intc/apic_common.c           |  21 ++++++
 include/hw/i386/apic_internal.h |  11 +++
 linux-headers/asm-x86/kvm.h     |   7 ++
 linux-headers/linux/kvm.h       |   7 ++
 target/i386/kvm/kvm.c           |  88 ++++++++++++++++++++++-
 target/i386/kvm/kvm_i386.h      |   7 +-
 7 files changed, 233 insertions(+), 31 deletions(-)

----------------------------------------------------------------------

New:  target/arm: Move TCG-specific code out of debug_helper.c
[PATCH v4 01/14] target/arm: Move TCG-specific code out of debug_helper.c
Author: Pierrick Bouvier <pierrick.bouvier@linaro.org>


The target/arm/debug_helper.c file has some code which we need
for non-TCG accelerators, but quite a lot which is guarded by
a CONFIG_TCG ifdef. Move all this TCG-only code out to a
new file target/arm/tcg/debug.c.

In particular all the code requiring access to the TCG
helper function prototypes is in the moved code, so we can
drop the use of tcg/helper.h from debug_helper.c.

Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
Reviewed-by: Pierrick Bouvier <pierrick.bouvier@linaro.org>
Reviewed-by: Richard Henderson <richard.henderson@linaro.org>
Signed-off-by: Pierrick Bouvier <pierrick.bouvier@linaro.org>
---
 target/arm/debug_helper.c  | 769 ------------------------------------
 target/arm/tcg/debug.c     | 782 +++++++++++++++++++++++++++++++++++++
 target/arm/tcg/meson.build |   2 +
 3 files changed, 784 insertions(+), 769 deletions(-)

----------------------------------------------------------------------

New:  target/arm: single-binary
[PATCH v4 00/14] target/arm: single-binary
Author: Pierrick Bouvier <pierrick.bouvier@linaro.org>

This series continues cleaning target/arm, especially tcg folder.

For now, it contains some cleanups in headers, and it splits helpers per
category, thus removing several usage of TARGET_AARCH64.
First version was simply splitting 32 vs 64-bit helpers, and Richard asked
to split per sub category.

v4
--

- add two patches from Peter removing helper in non-tcg files
  20260216160349.3079657-1-peter.maydell@linaro.org
  This fixes build failure with kvm-only and xen-only builds on aarch64.
  I didn't split helper and gen_helper headers. If that really matters, it can
  be done in v5.

v3
--

- translate.h: missing vaddr replacement
- move tcg_use_softmmu to tcg/tcg-internal.h to avoid duplicating compilation
  units between system and user builds.
- eradicate TARGET_INSN_START_EXTRA_WORDS by calling tcg_gen_insn_start with
  additional 0 parameters if needed.

v2
--

- add missing kvm_enabled() in arm-qmp-cmds.c
- didn't extract arm_wfi for tcg/psci.c. If that's a hard requirement, I can do
  it in next version.
- restricted scope of series to helper headers, so we can validate things one
  step at a time. Series will keep on growing once all patches are reviewed.
- translate.h: use vaddr where appropriate, as asked by Richard.

Peter Maydell (2):
  target/arm: Move TCG-specific code out of debug_helper.c
  target/arm: Don't require helper prototypes in helper.c

Pierrick Bouvier (12):
  target/arm: extract helper-mve.h from helper.h
  target/arm: extract helper-a64.h from helper.h
  target/arm: extract helper-sve.h from helper.h
  target/arm: extract helper-sme.h from helper.h
  tcg: move tcg_use_softmmu to tcg/tcg-internal.h
  target/arm: move exec/helper-* plumbery to helper.h
  target/arm/tcg/psci.c: make compilation unit common
  target/arm/tcg/cpu-v7m.c: make compilation unit common
  target/arm/tcg/vec_helper.c: make compilation unit common
  target/arm/tcg/translate.h: replace target_ulong with vaddr
  target/arm/tcg/translate.h: replace target_long with int64_t
  include/tcg/tcg-op.h: eradicate TARGET_INSN_START_EXTRA_WORDS

 include/tcg/tcg-op-common.h                   |   8 +
 include/tcg/tcg-op.h                          |  29 -
 include/tcg/tcg.h                             |   6 -
 target/alpha/cpu-param.h                      |   2 -
 target/arm/cpu-param.h                        |   7 -
 target/arm/helper-a64.h                       |  14 +
 target/arm/helper-mve.h                       |  14 +
 target/arm/helper-sme.h                       |  14 +
 target/arm/helper-sve.h                       |  14 +
 target/arm/helper.h                           |  17 +-
 .../tcg/{helper-a64.h => helper-a64-defs.h}   |   0
 target/arm/tcg/{helper.h => helper-defs.h}    |   0
 .../tcg/{helper-mve.h => helper-mve-defs.h}   |   0
 .../tcg/{helper-sme.h => helper-sme-defs.h}   |   0
 .../tcg/{helper-sve.h => helper-sve-defs.h}   |   0
 target/arm/tcg/translate-a32.h                |   2 +-
 target/arm/tcg/translate.h                    |  22 +-
 target/arm/tcg/vec_internal.h                 |  49 ++
 target/avr/cpu-param.h                        |   2 -
 target/hexagon/cpu-param.h                    |   2 -
 target/hppa/cpu-param.h                       |   2 -
 target/i386/cpu-param.h                       |   2 -
 target/loongarch/cpu-param.h                  |   2 -
 target/m68k/cpu-param.h                       |   2 -
 target/microblaze/cpu-param.h                 |   2 -
 target/mips/cpu-param.h                       |   2 -
 target/or1k/cpu-param.h                       |   2 -
 target/ppc/cpu-param.h                        |   2 -
 target/riscv/cpu-param.h                      |   7 -
 target/rx/cpu-param.h                         |   2 -
 target/s390x/cpu-param.h                      |   2 -
 target/sh4/cpu-param.h                        |   2 -
 target/sparc/cpu-param.h                      |   2 -
 target/tricore/cpu-param.h                    |   2 -
 target/xtensa/cpu-param.h                     |   2 -
 tcg/tcg-internal.h                            |   6 +
 target/alpha/translate.c                      |   4 +-
 target/arm/debug_helper.c                     | 769 -----------------
 target/arm/helper.c                           |   5 +-
 target/arm/tcg/arith_helper.c                 |   4 +-
 target/arm/tcg/crypto_helper.c                |   4 +-
 target/arm/tcg/debug.c                        | 780 ++++++++++++++++++
 target/arm/tcg/gengvec64.c                    |   3 +-
 target/arm/tcg/helper-a64.c                   |   6 +-
 target/arm/tcg/hflags.c                       |   4 +-
 target/arm/tcg/m_helper.c                     |   2 +-
 target/arm/tcg/mte_helper.c                   |   3 +-
 target/arm/tcg/mve_helper.c                   |   6 +-
 target/arm/tcg/neon_helper.c                  |   4 +-
 target/arm/tcg/op_helper.c                    |   2 +-
 target/arm/tcg/pauth_helper.c                 |   3 +-
 target/arm/tcg/psci.c                         |   4 +-
 target/arm/tcg/sme_helper.c                   |   5 +-
 target/arm/tcg/sve_helper.c                   |   6 +-
 target/arm/tcg/tlb_helper.c                   |   4 +-
 target/arm/tcg/translate-a64.c                |   3 +
 target/arm/tcg/translate-mve.c                |   1 +
 target/arm/tcg/translate-sme.c                |   3 +
 target/arm/tcg/translate-sve.c                |   3 +
 target/arm/tcg/translate.c                    |  28 +-
 target/arm/tcg/vec_helper.c                   | 224 +----
 target/arm/tcg/vec_helper64.c                 | 142 ++++
 target/arm/tcg/vfp_helper.c                   |   4 +-
 target/avr/translate.c                        |   2 +-
 target/hexagon/translate.c                    |   2 +-
 target/i386/tcg/translate.c                   |   2 +-
 target/loongarch/tcg/translate.c              |   2 +-
 target/m68k/translate.c                       |   2 +-
 target/microblaze/translate.c                 |   2 +-
 target/or1k/translate.c                       |   2 +-
 target/ppc/translate.c                        |   2 +-
 target/rx/translate.c                         |   2 +-
 target/sh4/translate.c                        |   4 +-
 target/sparc/translate.c                      |   2 +-
 target/tricore/translate.c                    |   2 +-
 target/xtensa/translate.c                     |   2 +-
 tcg/tcg.c                                     |   4 -
 target/arm/tcg/meson.build                    |  13 +-
 78 files changed, 1165 insertions(+), 1149 deletions(-)

----------------------------------------------------------------------

New:  KVM: x86/mmu: Don't create SPTEs for addresses that aren't mappable
[PATCH] KVM: x86/mmu: Don't create SPTEs for addresses that aren't mappable
Author: Sean Christopherson <seanjc@google.com>

Track the mask of guest physical address bits that can actually be mapped
by a given MMU instance that utilizes TDP, and either exit to userspace
with -EFAULT or go straight to emulation without creating an SPTE (for
emulated MMIO) if KVM can't map the address.  Attempting to create an SPTE
can cause KVM to drop the unmappable bits, and thus install a bad SPTE.
E.g. when starting a walk, the TDP MMU will round the GFN based on the
root level, and drop the upper bits.

Exit with -EFAULT in the unlikely scenario userspace is misbehaving and
created a memslot that can't be addressed, e.g. if userspace installed
memory above the guest.MAXPHYADDR defined in CPUID, as there's nothing KVM
can do to make forward progress, and there _is_ a memslot for the address.
For emulated MMIO, KVM can at least kick the bad address out to userspace
via a normal MMIO exit.

The flaw has existed for a very long time, and was exposed by commit
988da7820206 ("KVM: x86/tdp_mmu: WARN if PFN changes for spurious faults")
thanks to a syzkaller program that prefaults memory at GPA 0x1000000000000
and then faults in memory at GPA 0x0 (the extra-large GPA gets wrapped to
'0').

  WARNING: arch/x86/kvm/mmu/tdp_mmu.c:1183 at kvm_tdp_mmu_map+0x5c3/0xa30 [kvm], CPU#125: syz.5.22/18468
  CPU: 125 UID: 0 PID: 18468 Comm: syz.5.22 Tainted: G S      W           6.19.0-smp--23879af241d6-next #57 NONE
  Tainted: [S]=CPU_OUT_OF_SPEC, [W]=WARN
  Hardware name: Google Izumi-EMR/izumi, BIOS 0.20250917.0-0 09/17/2025
  RIP: 0010:kvm_tdp_mmu_map+0x5c3/0xa30 [kvm]
  Call Trace:
   <TASK>
   kvm_tdp_page_fault+0x107/0x140 [kvm]
   kvm_mmu_do_page_fault+0x121/0x200 [kvm]
   kvm_arch_vcpu_pre_fault_memory+0x18c/0x230 [kvm]
   kvm_vcpu_pre_fault_memory+0x116/0x1e0 [kvm]
   kvm_vcpu_ioctl+0x3a5/0x6b0 [kvm]
   __se_sys_ioctl+0x6d/0xb0
   do_syscall_64+0x8d/0x900
   entry_SYSCALL_64_after_hwframe+0x4b/0x53
   </TASK>

In practice, the flaw is benign (other than the new WARN) as it only
affects guests that ignore guest.MAXPHYADDR (e.g. on CPUs with 52-bit
physical addresses but only 4-level paging) or guests being run by a
misbehaving userspace VMM (e.g. a VMM that ignored allow_smaller_maxphyaddr
or is pre-faulting bad addresses).

For non-TDP shadow paging, always clear the unmappable mask as the flaw
only affects GPAs affected.  For 32-bit paging, 64-bit virtual addresses
simply don't exist.  Even when software can shove a 64-bit address
somewhere, e.g. into SYSENTER_EIP, the value is architecturally truncated
before it reaches the page table walker.  And for 64-bit paging, KVM's use
of 4-level vs. 5-level paging is tied to the guest's CR4.LA57, i.e. KVM
won't observe a 57-bit virtual address with a 4-level MMU.

Cc: Rick Edgecombe <rick.p.edgecombe@intel.com>
Cc: Yosry Ahmed <yosry.ahmed@linux.dev>
Cc: Yan Zhao <yan.y.zhao@intel.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/include/asm/kvm_host.h |  6 +++++
 arch/x86/kvm/mmu/mmu.c          | 42 +++++++++++++++++++++++++++++++++
 2 files changed, 48 insertions(+)

----------------------------------------------------------------------

New:  KVM: SVM: Explicitly mark vmcb01 dirty after modifying
[PATCH v2 1/8] KVM: SVM: Explicitly mark vmcb01 dirty after modifying
Author: Sean Christopherson <seanjc@google.com>

When reacting to an intercept update, explicitly mark vmcb01's intercepts
dirty, as KVM always initially operates on vmcb01, and nested_svm_vmexit()
isn't guaranteed to mark VMCB_INTERCEPTS as dirty.  I.e. if L2 is active,
KVM will modify the intercepts for L1, but might not mark them as dirty
before the next VMRUN of L1.

Fixes: 116a0a23676e ("KVM: SVM: Add clean-bit for intercetps, tsc-offset and pause filter count")
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/svm/nested.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

----------------------------------------------------------------------

New:  KVM: SVM: A fix and cleanups for VMCB intercepts
[PATCH v2 0/8] KVM: SVM: A fix and cleanups for VMCB intercepts
Author: Sean Christopherson <seanjc@google.com>

Fix a likely-benign bug where KVM fails to mark vmcb01 intercepts as dirty
after recalculating intercepts while L2 is active, then do a bunch of related
cleanup, e.g. to split recalc_intercepts() into nested vs. non-nested
functionality.

v2:
 - Fix the aforementioned bug.
 - Split recalc_intercepts() instead of simply renaming it.
 - Move the new WARN in nested_vmcb02_recalc_intercepts() to its own patch.
 - Use less weird local variables even if they aren't consistent with the
   existing code...
 - ... and then change some names in the existing code to provide consistency.

v1: https://lkml.kernel.org/r/20260112182022.771276-1-yosry.ahmed%40linux.dev

Sean Christopherson (6):
  KVM: SVM: Explicitly mark vmcb01 dirty after modifying VMCB intercepts
  KVM: SVM: Separate recalc_intercepts() into nested vs. non-nested
    parts
  KVM: nSVM: Directly (re)calc vmcb02 intercepts from
    nested_vmcb02_prepare_control()
  KVM: nSVM: Use intuitive local variables in
    nested_vmcb02_recalc_intercepts()
  KVM: nSVM: Move vmcb_ctrl_area_cached.bus_lock_rip to svm_nested_state
  KVM: nSVM: Capture svm->nested.ctl as vmcb12_ctrl when preparing
    vmcb02

Yosry Ahmed (2):
  KVM: nSVM: WARN and abort vmcb02 intercepts recalc if vmcb02 isn't
    active
  KVM: nSVM: Use vmcb12_is_intercept() in
    nested_sync_control_from_vmcb02()

 arch/x86/kvm/svm/nested.c | 88 +++++++++++++++++++--------------------
 arch/x86/kvm/svm/sev.c    |  2 +-
 arch/x86/kvm/svm/svm.c    |  6 +--
 arch/x86/kvm/svm/svm.h    | 28 +++++++++----
 4 files changed, 67 insertions(+), 57 deletions(-)

----------------------------------------------------------------------

