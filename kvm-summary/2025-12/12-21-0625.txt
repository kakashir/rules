From a4f0e95a9 to d979f13e0
KVM mailing list update from a4f0e95a9 to d979f13e0

Top 15 contributor Email domains (Based on Email Body)

     13 google.com
      3 bytedance.com
      1 pooladkhay.com

Top 15 contributors (Based on Email Body)

     10  Kevin Cheng <chengkev@google.com>
      3  Xu Lu <luxu.kernel@bytedance.com>
      3  David Matlack <dmatlack@google.com>
      1  MJ Pooladkhay <mj@pooladkhay.com>

===== Patch list in this time period =====


===== Patch Commit Messages ====

New:  irqchip/riscv-imsic: Adjust vs irq files num according to MMIO resources
[PATCH] irqchip/riscv-imsic: Adjust vs irq files num according to MMIO resources
Author: Xu Lu <luxu.kernel@bytedance.com>

During initialization, kernel maps the MMIO resources of IMSIC, which is
parsed from ACPI or DTS and may not strictly contains all guest
interrupt files. Page fault happens when KVM wrongly allocates an
unmapped guest interrupt file and writes it.

Thus, during initialization, we calculate the number of available guest
interrupt files according to MMIO resources and constrain the number of
guest interrupt files that can be allocated by KVM.

Signed-off-by: Xu Lu <luxu.kernel@bytedance.com>
---
 arch/riscv/kvm/aia.c                    | 2 +-
 drivers/irqchip/irq-riscv-imsic-state.c | 7 ++++++-
 include/linux/irqchip/riscv-imsic.h     | 3 +++
 3 files changed, 10 insertions(+), 2 deletions(-)

----------------------------------------------------------------------

New:  KVM: selftests: Fix sign extension bug in get_desc64_base()
[PATCH] KVM: selftests: Fix sign extension bug in get_desc64_base()
Author: MJ Pooladkhay <mj@pooladkhay.com>

The function get_desc64_base() performs a series of bitwise left shifts on
fields of various sizes. More specifically, when performing '<< 24' on
'desc->base2' (which is a u8), 'base2' is promoted to a signed integer
before shifting.

In a scenario where base2 >= 0x80, the shift places a 1 into bit 31,
causing the 32-bit intermediate value to become negative. When this
result is cast to uint64_t or ORed into the return value, sign extension
occurs, corrupting the upper 32 bits of the address (base3).

Example:
Given:
  base0 = 0x5000
  base1 = 0xd6
  base2 = 0xf8
  base3 = 0xfffffe7c

Expected return: 0xfffffe7cf8d65000
Actual return:   0xfffffffff8d65000

Fix this by explicitly casting the fields to 'uint64_t' before shifting
to prevent sign extension.

Signed-off-by: MJ Pooladkhay <mj@pooladkhay.com>
---
While using get_desc64_base() to set the HOST_TR_BASE value for a custom 
educational hypervisor, I observed system freezes, either immediately or
after migrating the guest to a new core. I eventually realized that KVM
uses get_cpu_entry_area() for the TR base. Switching to that fixed my
freezes (which were triple faults on one core followed by soft lockups 
on others, waiting on smp_call_function_many_cond) and helped me identify
the sign-extension bug in this helper function that was corrupting the
HOST_TR_BASE value.

Thanks,
MJ Pooladkhay

 tools/testing/selftests/kvm/include/x86/processor.h | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

----------------------------------------------------------------------

New:  tools include: Add definitions for __aligned_{l,b}e64
[PATCH 1/2] tools include: Add definitions for __aligned_{l,b}e64
Author: David Matlack <dmatlack@google.com>

Add definitions for the missing __aligned_le64 and __aligned_be64 to
tools/include/linux/types.h. The former is needed by <linux/iommufd.h>
for builds where tools/include/ is on the include path ahead of
usr/include/.

Signed-off-by: David Matlack <dmatlack@google.com>
---
 tools/include/linux/types.h | 8 ++++++++
 1 file changed, 8 insertions(+)

----------------------------------------------------------------------

New:  vfio: selftests: Clean up <uapi/linux/types.h> includes
[PATCH 0/2] vfio: selftests: Clean up <uapi/linux/types.h> includes
Author: David Matlack <dmatlack@google.com>

Small clean up series to eliminate the extra includes of
<uapi/linux/types.h> from various VFIO selftests files. This include is
not causing any problems now, but it is causing benign typedef
redifinitions. Those redifinitions will become a problem when the VFIO
selftests library is built into KVM selftests, since KVM selftests build
with -std=gnu99.

Cc: Yosry Ahmed <yosryahmed@google.com>
Cc: Josh Hilke <jrhilke@google.com>

David Matlack (2):
  tools include: Add definitions for __aligned_{l,b}e64
  vfio: selftests: Drop <uapi/linux/types.h> includes

 tools/include/linux/types.h                               | 8 ++++++++
 .../selftests/vfio/lib/include/libvfio/iova_allocator.h   | 1 -
 tools/testing/selftests/vfio/lib/iommu.c                  | 1 -
 tools/testing/selftests/vfio/lib/iova_allocator.c         | 1 -
 tools/testing/selftests/vfio/lib/vfio_pci_device.c        | 1 -
 tools/testing/selftests/vfio/vfio_dma_mapping_test.c      | 1 -
 tools/testing/selftests/vfio/vfio_iommufd_setup_test.c    | 1 -
 7 files changed, 8 insertions(+), 6 deletions(-)

----------------------------------------------------------------------

New:  x86/svm: Fix virq_inject SVM test failure
[kvm-unit-tests PATCH 1/9] x86/svm: Fix virq_inject SVM test failure
Author: Kevin Cheng <chengkev@google.com>

Currently, the virq_inject test advances guest RIP regardless of what
instruction caused the nested VM exit. This is an issue when
INTERCEPT_VINTR is set and the sti_nop_cli() is called in L2 with a
pending interrupt. The vmcb save rip will point to the nop instruction
on exit due to a one instruction interrupt shadow. The unconditional
advance of the guest rip will move it three bytes, which is past the
entire sti_nop_cli() call. This produces some unintended/inconsitent
behavior including test failures.

Only advance the guest rip if the exiting instruction was vmmcall().

Signed-off-by: Kevin Cheng <chengkev@google.com>
---
 x86/svm_tests.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

----------------------------------------------------------------------

New:  Improve test parity between SVM and VMX
[kvm-unit-tests PATCH 0/9] Improve test parity between SVM and VMX
Author: Kevin Cheng <chengkev@google.com>

This series introduces numerous tests for features that VMX testing
covers but current SVM testing lacks.

I went through all VMX tests and identified which ones could have an
equivalent test written for SVM. If there are any gaps in testing that I
may have missed and you would like to see an equivalent SVM test for,
feel free to add a suggestion and I can take a look :)

Note: This series includes and supersedes the standalone patches:
  - [kvm-unit-tests PATCH] x86: nSVM: Add test for EPT A/D bits sent on
    20 Aug 2025
      - Changes suggested by Sean for this patch have been fixed and
        included in this series
  - [kvm-unit-tests PATCH] x86/svm: Add unsupported instruction
    intercept test sent on 20 Aug 2025

Thanks,
Kevin

Kevin Cheng (9):
  x86/svm: Fix virq_inject SVM test failure
  x86/nSVM: Add test for NPT A/D bits
  x86/svm: Add tests for APIC passthrough
  x86/nSVM: Add tests for instruction interrupts
  x86/svm: Add tests for PF exception testing
  x86/svm: Extend NPT test coverage for different page table levels
  x86/svm: Add NPT ignored bits test
  x86/svm: Add testing for NPT permissions on guest page tables
  x86/svm: Add event injection check tests

 lib/x86/processor.h |   6 +
 lib/x86/vm.c        |   2 +-
 lib/x86/vm.h        |   2 +
 x86/Makefile.common |   2 +
 x86/access.c        |   7 -
 x86/access.h        |  11 +
 x86/svm.c           |  16 +-
 x86/svm.h           |   9 +
 x86/svm_npt.c       | 799 ++++++++++++++++++++++++++++++++++++++++----
 x86/svm_tests.c     | 644 +++++++++++++++++++++++++++++++----
 x86/unittests.cfg   |  47 ++-
 x86/vmx_tests.c     |   5 -
 12 files changed, 1406 insertions(+), 144 deletions(-)

----------------------------------------------------------------------

