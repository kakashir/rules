From e5d776dd9 to 793f3e63a
KVM mailing list update from e5d776dd9 to 793f3e63a

Top 15 contributor Email domains (Based on Email Body)

     12 arm.com
     10 kernel.org
      5 redhat.com

Top 15 contributors (Based on Email Body)

     10  Marc Zyngier <maz@kernel.org>
     10  Joey Gouly <joey.gouly@arm.com>
      5  Peter Xu <peterx@redhat.com>
      2  Alexandru Elisei <alexandru.elisei@arm.com>

===== Patch list in this time period =====


===== Patch Commit Messages ====

New:  mm/thp: Allow thp_get_unmapped_area_vmflags() to take alignment
[PATCH v2 1/4] mm/thp: Allow thp_get_unmapped_area_vmflags() to take alignment
Author: Peter Xu <peterx@redhat.com>

Add "align" parameter to thp_get_unmapped_area_vmflags() so that it allows
get unmapped area with any alignment.

There're two existing callers, use PMD_SIZE explicitly for them.

No functional change intended.

Signed-off-by: Peter Xu <peterx@redhat.com>
---
 include/linux/huge_mm.h | 5 +++--
 mm/huge_memory.c        | 7 ++++---
 mm/mmap.c               | 3 ++-
 3 files changed, 9 insertions(+), 6 deletions(-)

----------------------------------------------------------------------

New:  mm/vfio: huge pfnmaps with !MAP_FIXED mappings
[PATCH v2 0/4] mm/vfio: huge pfnmaps with !MAP_FIXED mappings
Author: Peter Xu <peterx@redhat.com>

This series is based on v6.18.  It allows mmap(!MAP_FIXED) to work with
huge pfnmaps with best effort.  Meanwhile, it enables it for vfio-pci as
the first user.

v1: https://lore.kernel.org/r/20250613134111.469884-1-peterx@redhat.com

A changelog may not apply because all the patches were rewrote based on a
new interface this v2 introduced.  Hence omitted.

In this version, a new file operation, get_mapping_order(), is introduced
(based on discussion with Jason on v1) to minimize the code needed for
drivers to implement this.  It also helps avoid exporting any mm functions.
One can refer to the discussion in v1 for more information.

Currently, get_mapping_order() API is define as:

  int (*get_mapping_order)(struct file *file, unsigned long pgoff, size_t len);

The first argument is the file pointer, the 2nd+3rd are the pgoff+len
specified from a mmap() request.  The driver can use this interface to
opt-in providing mapping order hints to core mm on VA allocations for the
range of the file specified.  I kept the interface as simple for now, so
that core mm will always do the alignment with pgoff assuming that would
always work.  The driver can only report the order from pgoff+len, which
will be used to do the alignment.

Before this series, an userapp in most cases need to be modified to benefit
from huge mappings to provide huge size aligned VA using MAP_FIXED.  After
this series, the userapp can benefit from huge pfnmap automatically after
the kernel upgrades, with no userspace modifications.

It's still best-effort, because the auto-alignment will require a larger VA
range to be allocated via the per-arch allocator, hence if the huge-mapping
aligned VA cannot be allocated then it'll still fallback to small mappings
like before.  However that's from theory POV: in reality I don't yet know
when it'll fail especially when on a 64bits system.

So far, only vfio-pci is supported.  But the logic should be applicable to
all the drivers that support or will support huge pfnmaps.  I've copied
some more people in this version too from hardware perspective.

For testings:

- checkpatch.pl
- cross build harness
- unit test that I got from Alex [1], checking mmap() alignments on a QEMU
  instance with an 128MB bar.

Checking the alignments look all sane with mmap(!MAP_FIXED), and huge
mappings properly installed.  I didn't observe anything wrong.

I currently lack larger bars to test PUD sizes.  Please kindly report if
one can run this with 1G+ bars and hit issues.

Alex Mastro: thanks for the testing offered in v1, but since this series
was rewritten, a re-test will be needed.  I hence didn't collect the T-b.

Comments welcomed, thanks.

[1] https://github.com/awilliam/tests/blob/vfio-pci-device-map-alignment/vfio-pci-device-map-alignment.c

Peter Xu (4):
  mm/thp: Allow thp_get_unmapped_area_vmflags() to take alignment
  mm: Add file_operations.get_mapping_order()
  vfio: Introduce vfio_device_ops.get_mapping_order hook
  vfio-pci: Best-effort huge pfnmaps with !MAP_FIXED mappings

 Documentation/filesystems/vfs.rst |  4 +++
 drivers/vfio/pci/vfio_pci.c       |  1 +
 drivers/vfio/pci/vfio_pci_core.c  | 49 ++++++++++++++++++++++++++
 drivers/vfio/vfio_main.c          | 14 ++++++++
 include/linux/fs.h                |  1 +
 include/linux/huge_mm.h           |  5 +--
 include/linux/vfio.h              |  5 +++
 include/linux/vfio_pci_core.h     |  2 ++
 mm/huge_memory.c                  |  7 ++--
 mm/mmap.c                         | 58 +++++++++++++++++++++++++++----
 10 files changed, 135 insertions(+), 11 deletions(-)

----------------------------------------------------------------------

New:  arm64: set SCTLR_EL1 to a known value for secondary cores
[kvm-unit-tests PATCH v4 01/11] arm64: set SCTLR_EL1 to a known value for secondary cores
Author: Joey Gouly <joey.gouly@arm.com>

This ensures that primary and secondary cores will have the same values for
SCTLR_EL1.

Signed-off-by: Joey Gouly <joey.gouly@arm.com>
---
 arm/cstart64.S | 5 +++++
 1 file changed, 5 insertions(+)

----------------------------------------------------------------------

New:  arm64: EL2 support
[kvm-unit-tests PATCH v4 00/11] arm64: EL2 support
Author: Joey Gouly <joey.gouly@arm.com>

Hi all,

This series is for adding support to running the kvm-unit-tests at EL2.

Changes since v3[1]:
	- Added rb/acks, thanks!
	- Fixed checkpatch.pl issues
	- Changed EL2=1 env var to EL2=y or EL2=Y
	- Couldn't make the change as suggested in [2] since those tests are
	  also run at EL0, where CurrentEL is UNDEFINED. So I have left the
	  #ifdef.
	- Fixed SCTLR_ELx initialisation on secondary cores.

Thanks,
Joey

[1] https://lore.kernel.org/kvmarm/20250925141958.468311-1-joey.gouly@arm.com/
[2] https://lore.kernel.org/kvmarm/20251202122115.GA3921791@e124191.cambridge.arm.com/

Alexandru Elisei (2):
  arm64: micro-bench: use smc when at EL2
  arm64: selftest: update test for running at EL2

Joey Gouly (9):
  arm64: set SCTLR_EL1 to a known value for secondary cores
  arm64: drop to EL1 if booted at EL2
  arm64: efi: initialise SCTLR_ELx fully
  arm64: efi: initialise the EL
  arm64: timer: use hypervisor timers when at EL2
  arm64: micro-bench: fix timer IRQ
  arm64: pmu: count EL2 cycles
  arm64: run at EL2 if supported
  arm64: add EL2 environment variable

 arm/cstart64.S             | 66 ++++++++++++++++++++++++++++++++++++--
 arm/efi/crt0-efi-aarch64.S |  5 +++
 arm/micro-bench.c          | 26 +++++++++++++--
 arm/pmu.c                  | 13 +++++---
 arm/run                    |  7 ++++
 arm/selftest.c             | 18 ++++++++---
 arm/timer.c                | 12 +++++--
 lib/acpi.h                 |  2 ++
 lib/arm/asm/setup.h        |  8 +++++
 lib/arm/asm/timer.h        | 11 +++++++
 lib/arm/setup.c            |  4 +++
 lib/arm/timer.c            | 19 +++++++++--
 lib/arm64/asm/sysreg.h     | 19 +++++++++++
 lib/arm64/processor.c      | 14 ++++++++
 14 files changed, 204 insertions(+), 20 deletions(-)

----------------------------------------------------------------------

New:  arm64: Repaint ID_AA64MMFR2_EL1.IDS description
[PATCH v3 1/9] arm64: Repaint ID_AA64MMFR2_EL1.IDS description
Author: Marc Zyngier <maz@kernel.org>

ID_AA64MMFR2_EL1.IDS, as described in the sysreg file, is pretty horrible
as it diesctly give the ESR value. Repaint it using the usual NI/IMP
identifiers to describe the absence/presence of FEAT_IDST.

Signed-off-by: Marc Zyngier <maz@kernel.org>
---
 arch/arm64/kvm/hyp/nvhe/sys_regs.c | 2 +-
 arch/arm64/tools/sysreg            | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

----------------------------------------------------------------------

New:  KVM: arm64: Add support for FEAT_IDST
[PATCH v3 0/9] KVM: arm64: Add support for FEAT_IDST
Author: Marc Zyngier <maz@kernel.org>

FEAT_IDST appeared in ARMv8.4, and allows ID registers to be trapped
if they are not implemented. This only concerns 3 registers (GMID_EL1,
CCSIDR2_EL1 and SMIDR_EL1), which are part of features that may not be
exposed to the guest even if present on the host.

For these registers, the HW should report them with EC=0x18, even if
the feature isn't implemented.

Add support for this feature by handling these registers in a specific
way and implementing GMID_EL1 support in the process. A very basic
selftest checks that these registers behave as expected.

* From v2: [2]

  - Repainted ID_AA64MMFR2_EL1.IDS description (Oliver)

  - Made the IDST handling more generic in the core KVM code, which
    resulted in the series being restructured a bit

  - Added handling to pKVM (in a slightly different way, as pKVM
    insist on seeing a full enumeration of the trapped registers)

  - Some cleanups

  - Collected RBs, with thanks

* From v1: [1]

  - Fixed commit message in patch #4 (Ben)

  - Collected RB, with thanks (Joey)

[1] https://lore.kernel.org/r/20251120133202.2037803-1-maz@kernel.org
[2] https://lore.kernel.org/r/20251126155951.1146317-1-maz@kernel.org

Marc Zyngier (9):
  arm64: Repaint ID_AA64MMFR2_EL1.IDS description
  KVM: arm64: Add trap routing for GMID_EL1
  KVM: arm64: Add a generic synchronous exception injection primitive
  KVM: arm64: Handle FEAT_IDST for sysregs without specific handlers
  KVM: arm64: Handle CSSIDR2_EL1 and SMIDR_EL1 in a generic way
  KVM: arm64: Force trap of GMID_EL1 when the guest doesn't have MTE
  KVM: arm64: pkvm: Add a generic synchronous exception injection
    primitive
  KVM: arm64: pkvm: Report optional ID register traps with a 0x18
    syndrome
  KVM: arm64: selftests: Add a test for FEAT_IDST

 arch/arm64/include/asm/kvm_emulate.h          |   1 +
 arch/arm64/kvm/emulate-nested.c               |  28 +++++
 arch/arm64/kvm/hyp/nvhe/sys_regs.c            |  39 ++++--
 arch/arm64/kvm/inject_fault.c                 |  10 +-
 arch/arm64/kvm/sys_regs.c                     |   4 +-
 arch/arm64/tools/sysreg                       |   4 +-
 tools/testing/selftests/kvm/Makefile.kvm      |   1 +
 .../testing/selftests/kvm/arm64/idreg-idst.c  | 117 ++++++++++++++++++
 8 files changed, 189 insertions(+), 15 deletions(-)

----------------------------------------------------------------------

