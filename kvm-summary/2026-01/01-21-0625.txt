From ee9e9e6ee to 01a6739c8
KVM mailing list update from ee9e9e6ee to 01a6739c8

Top 15 contributor Email domains (Based on Email Body)

     28 oss.qualcomm.com
      7 suse.de
      7 nvidia.com
      6 163.com
      1 kernel.org
      1 google.com
      1 amazon.co.uk

Top 15 contributors (Based on Email Body)

     28  Anup Patel <anup.patel@oss.qualcomm.com>
      7  =?UTF-8?q?Carlos=20L=C3=B3pez?= <clopez@suse.de>
      7  Leon Romanovsky <leonro@nvidia.com>
      6  Zhiquan Li <zhiquan_li@163.com>
      1  Sean Christopherson <seanjc@google.com>
      1  Leon Romanovsky <leon@kernel.org>
      1  Fred Griffoul <fgriffo@amazon.co.uk>

===== Patch list in this time period =====


===== Patch Commit Messages ====

New:  x86/tdx: Use pg_level in TDX APIs, not the TDX-Module's
[PATCH] x86/tdx: Use pg_level in TDX APIs, not the TDX-Module's
Author: Sean Christopherson <seanjc@google.com>

Rework the TDX APIs to take the kernel's 1-based pg_level enum, not the
TDX-Module's 0-based level.  The APIs are _kernel_ APIs, not TDX-Module
APIs, and the kernel (and KVM) uses "enum pg_level" literally everywhere.

Using "enum pg_level" eliminates ambiguity when looking at the APIs (it's
NOT clear that "int level" refers to the TDX-Module's level), and will
allow for using existing helpers like page_level_size() when support for
hugepages is added to the S-EPT APIs.

No functional change intended.

Cc: Kai Huang <kai.huang@intel.com>
Cc: Dave Hansen <dave.hansen@linux.intel.com>
Cc: Rick Edgecombe <rick.p.edgecombe@intel.com>
Cc: Yan Zhao <yan.y.zhao@intel.com>
Cc: Vishal Annapurve <vannapurve@google.com>
Cc: Ackerley Tng <ackerleytng@google.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
---

Compile-tested only.  Came across this when looking at the S-EPT hugepage
series, specifically this code:
  
   unsigned long npages = 1 << (level * PTE_SHIFT);

which I was _sure_ was broken, until I realized @level wasn't what I thought
it was.
 
 arch/x86/include/asm/tdx.h  | 14 ++++----------
 arch/x86/kvm/vmx/tdx.c      | 11 ++++-------
 arch/x86/virt/vmx/tdx/tdx.c | 26 ++++++++++++++++++--------
 3 files changed, 26 insertions(+), 25 deletions(-)

----------------------------------------------------------------------

New:  KVM: SEV: use mutex guard in snp_launch_update()
[PATCH v2 1/6] KVM: SEV: use mutex guard in snp_launch_update()
Author: Carlos López <clopez@suse.de>

Simplify the error paths in snp_launch_update() by using a mutex guard,
allowing early return instead of using gotos.

Signed-off-by: Carlos López <clopez@suse.de>
---
 arch/x86/kvm/svm/sev.c | 31 ++++++++++++-------------------
 1 file changed, 12 insertions(+), 19 deletions(-)

----------------------------------------------------------------------

New:  KVM: SEV: use mutex guards for simpler error handling
[PATCH v2 0/6] KVM: SEV: use mutex guards for simpler error handling
Author: Carlos López <clopez@suse.de>

Replace several uses of mutex_lock() / mutex_unlock() pairs with mutex
guards, which are less error-prone and help simplify error paths,
allowing removal of all gotos in some functions. This removes around 40
lines of code in total.

This does not remove all uses of the manual lock APIs, only those that
have their error handling improved by switching to the newer API.

Changes are separated per-function for ease of review.

---
v2: Removed an unnecessary include.

Carlos López (6):
  KVM: SEV: use mutex guard in snp_launch_update()
  KVM: SEV: use mutex guard in sev_mem_enc_ioctl()
  KVM: SEV: use mutex guard in sev_mem_enc_register_region()
  KVM: SEV: use mutex guard in sev_mem_enc_unregister_region()
  KVM: SEV: use mutex guard in snp_handle_guest_req()
  KVM: SEV: use scoped mutex guard in sev_asid_new()

 arch/x86/kvm/svm/sev.c | 134 ++++++++++++++---------------------------
 1 file changed, 46 insertions(+), 88 deletions(-)

----------------------------------------------------------------------

New:  KVM: nVMX: Track vmx emulation errors
[PATCH] KVM: nVMX: Track vmx emulation errors
Author: Fred Griffoul <griffoul@gmail.com>


Add a new kvm_stat vcpu counter called "nested_errors" to track the
number of errors returned to an L1 hypervisor when emulated VMX
instructions fail.

This counter should help monitor nVMX health and troubleshoot issues
with L1 hypervisors.

Signed-off-by: Fred Griffoul <fgriffo@amazon.co.uk>
---
 arch/x86/include/asm/kvm_host.h | 1 +
 arch/x86/kvm/vmx/nested.c       | 2 ++
 arch/x86/kvm/x86.c              | 1 +
 3 files changed, 4 insertions(+)

----------------------------------------------------------------------

New:  dma-buf: Rename .move_notify() callback to a clearer identifier
[PATCH v3 1/7] dma-buf: Rename .move_notify() callback to a clearer identifier
Author: Leon Romanovsky <leon@kernel.org>


Rename the .move_notify() callback to .invalidate_mappings() to make its
purpose explicit and highlight that it is responsible for invalidating
existing mappings.

Suggested-by: Christian König <christian.koenig@amd.com>
Reviewed-by: Christian König <christian.koenig@amd.com>
Signed-off-by: Leon Romanovsky <leonro@nvidia.com>
---
 drivers/dma-buf/dma-buf.c                   | 6 +++---
 drivers/gpu/drm/amd/amdgpu/amdgpu_dma_buf.c | 4 ++--
 drivers/gpu/drm/virtio/virtgpu_prime.c      | 2 +-
 drivers/gpu/drm/xe/tests/xe_dma_buf.c       | 6 +++---
 drivers/gpu/drm/xe/xe_dma_buf.c             | 2 +-
 drivers/infiniband/core/umem_dmabuf.c       | 4 ++--
 drivers/infiniband/hw/mlx5/mr.c             | 2 +-
 drivers/iommu/iommufd/pages.c               | 2 +-
 include/linux/dma-buf.h                     | 6 +++---
 9 files changed, 17 insertions(+), 17 deletions(-)

----------------------------------------------------------------------

New:  dma-buf: Use revoke mechanism to invalidate shared buffers
[PATCH v3 0/7] dma-buf: Use revoke mechanism to invalidate shared buffers
Author: Leon Romanovsky <leon@kernel.org>

Changelog:
v3:
 * Used Jason's wordings for commits and cover letter.
 * Removed IOMMUFD patch.
 * Renamed dma_buf_attachment_is_revoke() to be dma_buf_attach_revocable().
 * Added patch to remove CONFIG_DMABUF_MOVE_NOTIFY.
 * Added Reviewed-by tags.
 * Called to dma_resv_wait_timeout() after dma_buf_move_notify() in VFIO.
 * Added dma_buf_attach_revocable() check to VFIO DMABUF attach function.
 * Slightly changed commit messages.
v2: https://patch.msgid.link/20260118-dmabuf-revoke-v2-0-a03bb27c0875@nvidia.com
 * Changed series to document the revoke semantics instead of
   implementing it.
v1: https://patch.msgid.link/20260111-dmabuf-revoke-v1-0-fb4bcc8c259b@nvidia.com

-------------------------------------------------------------------------
This series documents a dma-buf “revoke” mechanism: to allow a dma-buf
exporter to explicitly invalidate (“kill”) a shared buffer after it has
been distributed to importers, so that further CPU and device access is
prevented and importers reliably observe failure.

The change in this series is to properly document and use existing core
“revoked” state on the dma-buf object and a corresponding exporter-triggered
revoke operation.

dma-buf has quietly allowed calling move_notify on pinned dma-bufs, even
though legacy importers using dma_buf_attach() would simply ignore
these calls.

RDMA saw this and needed to use allow_peer2peer=true, so implemented a
new-style pinned importer with an explicitly non-working move_notify()
callback.

This has been tolerable because the existing exporters are thought to
only call move_notify() on a pinned DMABUF under RAS events and we
have been willing to tolerate the UAF that results by allowing the
importer to continue to use the mapping in this rare case.

VFIO wants to implement a pin supporting exporter that will issue a
revoking move_notify() around FLRs and a few other user triggerable
operations. Since this is much more common we are not willing to
tolerate the security UAF caused by interworking with non-move_notify()
supporting drivers. Thus till now VFIO has required dynamic importers,
even though it never actually moves the buffer location.

To allow VFIO to work with pinned importers, according to how dma-buf
was intended, we need to allow VFIO to detect if an importer is legacy
or RDMA and does not actually implement move_notify().

Introduce a new function that exporters can call to detect these less
capable importers. VFIO can then refuse to accept them during attach.

In theory all exporters that call move_notify() on pinned dma-buf's
should call this function, however that would break a number of widely
used NIC/GPU flows. Thus for now do not spread this further than VFIO
until we can understand how much of RDMA can implement the full
semantic.

In the process clarify how move_notify is intended to be used with
pinned dma-bufs.

Thanks

Signed-off-by: Leon Romanovsky <leonro@nvidia.com>
---
Leon Romanovsky (7):
      dma-buf: Rename .move_notify() callback to a clearer identifier
      dma-buf: Always build with DMABUF_MOVE_NOTIFY
      dma-buf: Document RDMA non-ODP invalidate_mapping() special case
      dma-buf: Add check function for revoke semantics
      iommufd: Pin dma-buf importer for revoke semantics
      vfio: Wait for dma-buf invalidation to complete
      vfio: Validate dma-buf revocation semantics

 drivers/dma-buf/Kconfig                     | 12 -----
 drivers/dma-buf/dma-buf.c                   | 69 +++++++++++++++++++++++------
 drivers/gpu/drm/amd/amdgpu/amdgpu_dma_buf.c | 14 +++---
 drivers/gpu/drm/amd/amdkfd/Kconfig          |  2 +-
 drivers/gpu/drm/virtio/virtgpu_prime.c      |  2 +-
 drivers/gpu/drm/xe/tests/xe_dma_buf.c       |  7 ++-
 drivers/gpu/drm/xe/xe_dma_buf.c             | 14 +++---
 drivers/infiniband/core/umem_dmabuf.c       | 13 +-----
 drivers/infiniband/hw/mlx5/mr.c             |  2 +-
 drivers/iommu/iommufd/pages.c               | 11 ++++-
 drivers/vfio/pci/vfio_pci_dmabuf.c          |  8 ++++
 include/linux/dma-buf.h                     |  9 ++--
 12 files changed, 96 insertions(+), 67 deletions(-)

----------------------------------------------------------------------

New:  KVM: x86: selftests: Add Hygon CPUs support and fix failures
[PATCH 0/5] KVM: x86: selftests: Add Hygon CPUs support and fix failures
Author: Zhiquan Li <zhiquan_li@163.com>

This series to add support for Hygon CPUs and fix some test failures.

Patch 1 add CPU vendor detection for Hygon and add a global variable
"host_cpu_is_hygon" to identify if the test is running on a Hygon CPU.
It is the prerequisite for the following fixes.

Patch 2 fix x86/fix_hypercall_test test failure by altering the instruction
of hypercall on Hygon CPUs.

Patch 3 fix following test failures by avoiding using the reserved memory
regions on Hygon CPUs.
- access_tracking_perf_test
- demand_paging_test
- dirty_log_perf_test
- dirty_log_test
- kvm_page_table_test
- memslot_modification_stress_test
- pre_fault_memory_test
- x86/dirty_log_page_splitting_test

Patch 4 fix x86/pmu_event_filter_test test failure by allowing the tests
for Hygon CPUs.

Patch 5 fix x86/msrs_test test failure by fixing the expectation while
writing the MSR_TSC_AUX reserved bits without RDPID support.

Zhiquan Li (5):
  KVM: x86: selftests: Add CPU vendor detection for Hygon
  KVM: x86: selftests: Alter the hypercall instruction on Hygon
  KVM: x86: selftests: Avoid failures due to reserved memory address
    regions on Hygon
  KVM: x86: selftests: Allow the PMU event filter test for Hygon
  KVM: x86: selftests: Fix write MSR_TSC_AUX reserved bits test failure
    on Hygon

 .../selftests/kvm/include/x86/processor.h     |  6 +++++
 .../testing/selftests/kvm/lib/x86/processor.c | 12 ++++++---
 .../selftests/kvm/x86/fix_hypercall_test.c    |  2 +-
 tools/testing/selftests/kvm/x86/msrs_test.c   | 26 +++++++++++++++----
 .../selftests/kvm/x86/pmu_event_filter_test.c |  6 ++---
 5 files changed, 39 insertions(+), 13 deletions(-)

----------------------------------------------------------------------

New:  KVM: x86: selftests: Add CPU vendor detection for Hygon
[PATCH 1/5] KVM: x86: selftests: Add CPU vendor detection for Hygon
Author: Zhiquan Li <zhiquan_li@163.com>

Currently some KVM selftests are failed on Hygon CPUs due to missing
vendor detection and edge-case handling specific to Hygon's
architecture.

Add CPU vendor detection for Hygon and add a global variable
"host_cpu_is_hygon" as the basic facility for the following fixes.

Signed-off-by: Zhiquan Li <zhiquan_li@163.com>
---
 tools/testing/selftests/kvm/include/x86/processor.h | 6 ++++++
 tools/testing/selftests/kvm/lib/x86/processor.c     | 3 +++
 2 files changed, 9 insertions(+)

----------------------------------------------------------------------

New:  Nested virtualization for KVM RISC-V
[PATCH 00/27] Nested virtualization for KVM RISC-V
Author: Anup Patel <anup.patel@oss.qualcomm.com>

Initial nested virtualization support for KVM RISC-V. Using
this series, we can boot Xvisor inside KVM guest and KVM RISC-V
insmod also works inside KVM guest but we can't run nested guest
at the moment due to work-in-progress G-stage emulation (or
G-stage page table walker).

Patch01-to-Patch09: Fixes and preparatory changes
Patch10-to-Patch23: Actual nested virtualization support
Patch24-to-Patch27: ONE_REG interface and get-reg-list selftest

Upcoming work on-top-of this series include:
 * Software MMU emulation for nested guest (aka swtlb)
 * HLV/HSV emulation
 * Sstc emulation for nested guest
 * SBI NACL for guest hypervisor
 * ... and more ...

These patches can also be found in the riscv_kvm_nested_v1
branch at: https://github.com/avpatel/linux.git

Anup Patel (27):
  RISC-V: KVM: Fix error code returned for Smstateen ONE_REG
  RISC-V: KVM: Fix error code returned for Ssaia ONE_REG
  RISC-V: KVM: Check host Ssaia extension when creating AIA irqchip
  RISC-V: KVM: Introduce common kvm_riscv_isa_check_host()
  RISC-V: KVM: Factor-out ISA checks into separate sources
  RISC-V: KVM: Move timer state defines closer to struct in UAPI header
  RISC-V: KVM: Add hideleg to struct kvm_vcpu_config
  RISC-V: KVM: Factor-out VCPU config into separate sources
  RISC-V: KVM: Don't check hstateen0 when updating sstateen0 CSR
  RISC-V: KVM: Initial skeletal nested virtualization support
  RISC-V: KVM: Use half VMID space for nested guest
  RISC-V: KVM: Extend kvm_riscv_mmu_update_hgatp() for nested
    virtualization
  RISC-V: KVM: Extend kvm_riscv_vcpu_config_load() for nested
    virtualization
  RISC-V: KVM: Extend kvm_riscv_vcpu_update_timedelta() for nested virt
  RISC-V: KVM: Extend trap redirection for nested virtualization
  RISC-V: KVM: Check and inject nested virtual interrupts
  RISC-V: KVM: Extend kvm_riscv_isa_check_host() for nested virt
  RISC-V: KVM: Trap-n-emulate SRET for Guest HS-mode
  RISC-V: KVM: Redirect nested supervisor ecall and breakpoint traps
  RISC-V: KVM: Redirect nested WFI and WRS traps
  RISC-V: KVM: Implement remote HFENCE SBI calls for guest
  RISC-V: KVM: Add CSR emulation for nested virtualization
  RISC-V: KVM: Add HFENCE emulation for nested virtualization
  RISC-V: KVM: Add ONE_REG interface for nested virtualization state
  RISC-V: KVM: selftests: Add nested virt state to get-reg-list test
  RISC-V: KVM: Add ONE_REG interface for nested virtualization CSRs
  RISC-V: KVM: selftests: Add nested virt CSRs to get-reg-list test

 arch/riscv/include/asm/csr.h                  |  17 +
 arch/riscv/include/asm/insn.h                 |   9 +
 arch/riscv/include/asm/kvm_gstage.h           |   2 +
 arch/riscv/include/asm/kvm_host.h             |  29 +-
 arch/riscv/include/asm/kvm_isa.h              |  20 +
 arch/riscv/include/asm/kvm_mmu.h              |   2 +-
 arch/riscv/include/asm/kvm_tlb.h              |  37 +-
 arch/riscv/include/asm/kvm_vcpu_config.h      |  25 ++
 arch/riscv/include/asm/kvm_vcpu_nested.h      | 163 ++++++++
 arch/riscv/include/asm/kvm_vcpu_timer.h       |   1 +
 arch/riscv/include/asm/kvm_vmid.h             |   1 +
 arch/riscv/include/uapi/asm/kvm.h             |  36 +-
 arch/riscv/kvm/Makefile                       |   6 +
 arch/riscv/kvm/aia.c                          |   4 +
 arch/riscv/kvm/aia_device.c                   |   5 +
 arch/riscv/kvm/gstage.c                       |  14 +
 arch/riscv/kvm/isa.c                          | 259 ++++++++++++
 arch/riscv/kvm/main.c                         |  13 +-
 arch/riscv/kvm/mmu.c                          |  18 +-
 arch/riscv/kvm/tlb.c                          | 135 +++++-
 arch/riscv/kvm/vcpu.c                         | 117 ++----
 arch/riscv/kvm/vcpu_config.c                  | 130 ++++++
 arch/riscv/kvm/vcpu_exit.c                    |  62 ++-
 arch/riscv/kvm/vcpu_fp.c                      |   9 +-
 arch/riscv/kvm/vcpu_insn.c                    |  46 +++
 arch/riscv/kvm/vcpu_nested.c                  | 258 ++++++++++++
 arch/riscv/kvm/vcpu_nested_csr.c              | 389 ++++++++++++++++++
 arch/riscv/kvm/vcpu_nested_insn.c             | 140 +++++++
 arch/riscv/kvm/vcpu_nested_swtlb.c            | 146 +++++++
 arch/riscv/kvm/vcpu_onereg.c                  | 334 +++------------
 arch/riscv/kvm/vcpu_pmu.c                     |   5 +-
 arch/riscv/kvm/vcpu_sbi_replace.c             |  63 ++-
 arch/riscv/kvm/vcpu_timer.c                   |  24 +-
 arch/riscv/kvm/vcpu_vector.c                  |   5 +-
 arch/riscv/kvm/vmid.c                         |  33 +-
 .../selftests/kvm/riscv/get-reg-list.c        | 106 ++++-
 36 files changed, 2244 insertions(+), 419 deletions(-)

----------------------------------------------------------------------

New:  RISC-V: KVM: Fix error code returned for Smstateen ONE_REG
[PATCH 01/27] RISC-V: KVM: Fix error code returned for Smstateen ONE_REG
Author: Anup Patel <anup.patel@oss.qualcomm.com>

Return -ENOENT for Smstateen ONE_REG when:
1) Smstateen is not enabled for a VCPU
2) When ONE_REG id is out of range

This will make Smstateen ONE_REG error codes consistent
with other ONE_REG interfaces of KVM RISC-V.

Fixes: c04913f2b54e ("RISCV: KVM: Add sstateen0 to ONE_REG")
Signed-off-by: Anup Patel <anup.patel@oss.qualcomm.com>
---
 arch/riscv/kvm/vcpu_onereg.c | 18 ++++++++----------
 1 file changed, 8 insertions(+), 10 deletions(-)

----------------------------------------------------------------------

